<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ScoreBoard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,#111827,#4f46e5);margin:0;padding:20px}
    .container{max-width:1100px;margin:auto;background:#fff;padding:22px 22px 28px;border-radius:18px;box-shadow:0 15px 40px rgba(0,0,0,.25);position:relative}
    h1{margin:6px 0 6px;text-align:center}
    .subh{margin:0 0 10px;text-align:center;color:#4b5563;font-size:13px}
    .top-right{position:absolute;top:14px;right:16px;display:flex;gap:10px;align-items:center}
    .link-btn{font-size:12px;color:#4f46e5;cursor:pointer;user-select:none;background:none;border:none}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;margin:6px 0}
    .section{margin-top:16px;padding:14px;border:1px solid #eef2ff;border-radius:14px;background:#fafbff}
    .section h3{margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{padding:10px;margin:6px 0;box-sizing:border-box;border-radius:10px;border:1px solid #d1d5db}
    input,select{width:100%}
    .row > *{flex:1 1 180px}
    button{background:#4f46e5;color:#fff;border:none;cursor:pointer;font-weight:900}
    button:hover{background:#4338ca}
    .ghost{background:#111827}
    .ghost:hover{background:#0b1220}
    .danger{background:#dc2626}
    .danger:hover{background:#b91c1c}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .muted{color:#6b7280;font-size:12px}
    .hidden{display:none !important}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .grid4{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width: 900px){.grid2,.grid4{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:12px}
    .card .t{font-weight:900;margin-bottom:4px}
    .card .d{font-size:13px;color:#374151}
    canvas{margin-top:10px}
    .btnbar{display:flex;gap:8px;flex-wrap:wrap}
    .btnbar button{width:auto;padding:8px 12px;border-radius:999px}
    .btnbar .active{outline:3px solid #c7d2fe}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:12px;overflow:hidden}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:center}
    th{background:#f3f4f6}
    .mini{font-size:12px}

    /* í•™ë…„ë„ íƒ­(í¬ë¡¬ íƒ­ ëŠë‚Œ) */
    .year-tabs{display:flex;gap:8px;align-items:flex-end;margin:10px 0 0}
    .year-tab{
      border:1px solid #e5e7eb;background:#f3f4f6;color:#111827;
      padding:8px 14px;border-bottom:none;border-top-left-radius:12px;border-top-right-radius:12px;
      cursor:pointer;font-weight:900;
    }
    .year-tab.active{background:#fff;color:#4f46e5;border-color:#c7d2fe}
    .year-tab.locked{opacity:.45;cursor:not-allowed}
    .year-bar{border:1px solid #c7d2fe;border-radius:14px;background:#fff;padding:10px 12px;margin-top:-1px}
  </style>
</head>

<body>
  <div class="container">
    <div class="top-right">
      <button id="manageTab" class="link-btn hidden" type="button">ê´€ë¦¬</button>
      <button id="logoutBtn" class="link-btn hidden" type="button">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <h1>ğŸ“Š ScoreBoard</h1>
    <div id="helloLine" class="subh hidden"></div>
    <div id="roleBadge" class="badge hidden"></div>

    <!-- ìµœì´ˆ ê´€ë¦¬ì ì„¤ì •(ìœ ì €ê°€ í•œ ë²ˆë§Œ ì…ë ¥) -->
    <div id="setupSection" class="section hidden">
      <h3>ğŸ§© ìµœì´ˆ 1íšŒ: ê´€ë¦¬ì(ì˜) ìƒì„±</h3>
      <div class="muted">* ë¹„ë°€ë²ˆí˜¸ëŠ” ì €ì¥ë  ë•Œ ì•”í˜¸í™”(í•´ì‹œ)ë¡œ ì €ì¥ë¼ì„œ í™”ë©´/ëª©ë¡ì— ì•ˆ ë³´ì—¬ìš”.</div>
      <div class="row">
        <input id="setupName" placeholder="ê´€ë¦¬ì ì´ë¦„ (ì˜ˆ: ë°•ì¤€ì„œ)" />
        <input id="setupPw" type="password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" />
        <button id="setupBtn" class="ghost" type="button">ê´€ë¦¬ì ìƒì„±</button>
      </div>
    </div>

    <!-- ë¡œê·¸ì¸ -->
    <div id="loginSection" class="section hidden">
      <h3>ğŸ” ë¡œê·¸ì¸</h3>
      <input id="pwInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
      <button id="loginBtn" type="button">ë¡œê·¸ì¸</button>
      <div class="muted">â€» ë¹„ë°€ë²ˆí˜¸ëŠ” í™”ë©´ì— í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    </div>

    <!-- í•™ë…„ë„ íƒ­ -->
    <div id="yearWrap" class="hidden">
      <div class="year-tabs">
        <button id="tab2026" class="year-tab" type="button" data-year="2026">2026í•™ë…„ë„</button>
        <button id="tab2027" class="year-tab" type="button" data-year="2027">2027í•™ë…„ë„</button>
      </div>
      <div class="year-bar">
        <div class="row" style="align-items:center">
          <div style="flex:1 1 260px">
            <span class="pill">í˜„ì¬ í•™ë…„ë„: <b id="currentYearLabel">2027</b></span>
            <span class="pill">í˜„ì¬ ë“±ê¸‰: <b id="currentGradeLabel">-</b></span>
          </div>
          <div style="flex:2 1 520px" class="muted">
            * í•œ/ì•½/ìˆ˜ëŠ” 2027í•™ë…„ë„ë§Œ ì—´ëŒ ê°€ëŠ¥. (ì˜/ì¹˜ëŠ” 2026/2027 ëª¨ë‘ ê°€ëŠ¥)
          </div>
        </div>
      </div>
    </div>

    <!-- ì„ íƒ -->
    <div id="pickSection" class="section hidden">
      <h3>ğŸ§­ ì„ íƒ</h3>

      <div class="row">
        <div style="flex:2 1 360px">
          <div class="muted">ì¢…ë¥˜ ì„ íƒ</div>
          <select id="typeSelect"></select>
        </div>
        <div style="flex:3 1 420px">
          <div class="muted">í˜„ì¬ ì„ íƒ</div>
          <div class="pill" id="currentPick">-</div>
        </div>
      </div>

      <div class="muted" style="margin-top:6px">ê³¼ëª© ì„ íƒ(ë²„íŠ¼)</div>
      <div id="subjectButtons" class="btnbar"></div>

      <div class="muted" style="margin-top:10px">íšŒì°¨ ì„ íƒ(ë²„íŠ¼) â€” ì˜ê°€ â€œíšŒì°¨ ìƒì„±â€í•˜ë©´ ìƒê¹€</div>
      <div id="roundButtons" class="btnbar"></div>

      <!-- ì˜ ì „ìš©: íšŒì°¨ ìƒì„± -->
      <div id="roundCreateSection" class="section hidden" style="background:#fff;margin-top:12px">
        <h3 style="margin:0 0 8px">â• íšŒì°¨ ìƒì„± (ì˜ ì „ìš©)</h3>
        <div class="muted">* (í•™ë…„ë„/ì¢…ë¥˜/ê³¼ëª©)ì— íšŒì°¨ë¥¼ ì¶”ê°€í•˜ë©´, ë°”ë¡œ íšŒì°¨ ë²„íŠ¼ì´ ìƒê²¨ìš”.</div>
        <div class="row">
          <input id="newRoundInput" type="number" placeholder="ì¶”ê°€í•  íšŒì°¨ (ì˜ˆ: 1)" />
          <button id="addRoundBtn" class="ghost" type="button">íšŒì°¨ ì¶”ê°€</button>
          <button id="delRoundBtn" class="danger" type="button">ì„ íƒ íšŒì°¨ ì‚­ì œ</button>
        </div>
      </div>
    </div>

    <!-- ì ìˆ˜ ì…ë ¥(ì˜ë§Œ) -->
    <div id="scoreEditorSection" class="section hidden">
      <h3>âœï¸ ì ìˆ˜ ì…ë ¥ (ì˜ ì „ìš©)</h3>
      <div class="row">
        <input id="scoreInput" type="number" placeholder="ì ìˆ˜" />
        <input id="percentileInput" type="number" placeholder="ë°±ë¶„ìœ„(ì„ íƒ)" min="0" max="100" />
        <button id="saveScoreBtn" type="button">ì €ì¥/ì—…ë°ì´íŠ¸</button>
      </div>
      <div class="muted">* (í•™ë…„ë„/ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨) ì¡°í•©ì´ ì´ë¯¸ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ì €ì¥</div>
    </div>

    <!-- ê·¸ë˜í”„ 4ê°œ -->
    <div id="chartsSection" class="section hidden">
      <h3>ğŸ“ˆ ê·¸ë˜í”„</h3>
      <div class="grid4">
        <div class="card">
          <div class="t">ê·¸ë˜í”„ 1) ì„ íƒí•œ ì¢…ë¥˜ Â· ê³¼ëª©ì˜ íšŒì°¨ë³„ ê²½í–¥</div>
          <div class="d mini">X=íšŒì°¨, Y=ì ìˆ˜ (0~100)</div>
          <canvas id="chart1"></canvas>
        </div>

        <div class="card">
          <div class="t">ê·¸ë˜í”„ 2) ì „ì²´ ì‹œí—˜ì—ì„œ í•´ë‹¹ ê³¼ëª© ê²½í–¥</div>
          <div class="d mini">ì¢…ë¥˜ ìƒê´€ì—†ì´ ê°™ì€ ê³¼ëª©ë§Œ</div>
          <canvas id="chart2"></canvas>
        </div>

        <div class="card">
          <div class="t">ê·¸ë˜í”„ 3) í•´ë‹¹ ì‹œí—˜ì—ì„œ ë¹„êµ(í‰ê· /ë“±ê¸‰ì»·)</div>
          <div class="d mini">ì˜ê°€ ì…ë ¥í•œ í‰ê· /ì»· ê¸°ì¤€</div>
          <canvas id="chart3"></canvas>
        </div>

        <div class="card">
          <div class="t">ê·¸ë˜í”„ 4) ë‹¨ì›ë³„ ì ìˆ˜ ë¹„êµ</div>
          <div class="d mini">ì˜ê°€ ì…ë ¥í•œ ë‹¨ì› ì ìˆ˜</div>
          <canvas id="chart4"></canvas>
        </div>
      </div>
    </div>

    <!-- ìƒì„¸ -->
    <div id="detailSection" class="section hidden">
      <h3>ğŸ“Œ ì„ íƒ ìƒì„¸</h3>
      <div class="grid2">
        <div class="card">
          <div class="t">ë‚´ ì ìˆ˜(ì„ íƒ ì¡°í•©)</div>
          <div class="d">ì ìˆ˜: <b id="myScoreLabel">-</b> / ë°±ë¶„ìœ„: <b id="myPctLabel">-</b></div>
        </div>
        <div class="card">
          <div class="t">ì‹œí—˜ í†µê³„(ë‹¤ë¥¸ì‚¬ëŒ ë¹„êµìš©)</div>
          <div class="d">í‰ê· : <b id="avgLabel">-</b></div>
          <div class="muted">* ë“±ê¸‰ì»·ì€ ê·¸ë˜í”„3ì— ì„ ìœ¼ë¡œ í‘œì‹œ</div>
        </div>
      </div>

      <div class="section" style="background:#fff;margin-top:12px">
        <h3 style="margin:0 0 8px">ë‹¨ì›ë³„ ì ìˆ˜</h3>
        <table>
          <thead><tr><th>ë‹¨ì›</th><th>ì ìˆ˜</th><th>ë§Œì </th></tr></thead>
          <tbody id="unitTable"></tbody>
        </table>
      </div>

      <div class="section" style="background:#fff;margin-top:12px">
        <h3 style="margin:0 0 8px">ğŸ“ ëŒ€í•™ ì¶”ì²œ</h3>
        <div class="muted">* ë‚´ â€œë°±ë¶„ìœ„â€ ê¸°ì¤€ìœ¼ë¡œ ìƒí–¥/ì ì •/ì•ˆì •ì„ ìë™ ë¶„ë¥˜í•´ ë³´ì—¬ì¤˜ìš”. (í•œ ë“±ê¸‰ ì´ìƒ ì—´ëŒ)</div>
        <div id="univCards" class="grid2" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- ê´€ë¦¬(ì˜ ì „ìš©) -->
    <div id="manageSection" class="section hidden">
      <h3>ğŸ›  ê´€ë¦¬ (ì˜ ì „ìš©)</h3>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§© ì¢…ë¥˜ ê´€ë¦¬(í•™ë…„ë„ë³„)</h3>
        <div class="row">
          <input id="newTypeInput" placeholder="ìƒˆ ì¢…ë¥˜ ì´ë¦„ (ì˜ˆ: í•™ë ¥í‰ê°€, ì„œë°”ì´ë²Œ)" />
          <button id="addTypeBtn" class="ghost" type="button">ì¢…ë¥˜ ì¶”ê°€</button>
        </div>
        <div id="typeList" class="muted"></div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ‘¤ ì‚¬ìš©ì ë“±ë¡(ì´ë¦„+ë¹„ë°€ë²ˆí˜¸+ë“±ê¸‰)</h3>
        <div class="row">
          <input id="newUserName" placeholder="ì´ë¦„" />
          <input id="newPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
          <select id="newGrade">
            <option value="ì¹˜">ì¹˜</option>
            <option value="í•œ">í•œ</option>
            <option value="ì•½">ì•½</option>
            <option value="ìˆ˜">ìˆ˜</option>
            <option value="ì˜">ì˜</option>
          </select>
          <button id="addUserBtn" class="ghost" type="button">ì¶”ê°€</button>
        </div>
        <div class="muted">* ë¹„ë°€ë²ˆí˜¸ëŠ” í•´ì‹œë¡œ ì €ì¥ë˜ì–´ ëª©ë¡/ì½”ë“œì— í‘œì‹œë˜ì§€ ì•ŠìŒ</div>
        <div id="userList" style="margin-top:10px"></div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§¾ ë¡œê·¸ì¸ ê¸°ë¡(ì˜ë§Œ ì—´ëŒ)</h3>
        <div id="loginRecords" class="muted">ê¸°ë¡ ì—†ìŒ</div>
        <button id="clearLogsBtn" class="danger" type="button">ë¡œê·¸ì¸ ê¸°ë¡ ì „ì²´ ì‚­ì œ</button>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ“Š ì‹œí—˜ í†µê³„ ì…ë ¥(ê·¸ë˜í”„3)</h3>
        <div class="muted">í˜„ì¬ ì„ íƒ(í•™ë…„ë„/ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨)ì— ëŒ€í•´ í‰ê· /ë“±ê¸‰ì»· ì €ì¥</div>
        <div class="row">
          <input id="statAvg" type="number" placeholder="í‰ê· (ì˜ˆ: 78)" />
          <input id="cut1" type="number" placeholder="1ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut2" type="number" placeholder="2ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut3" type="number" placeholder="3ë“±ê¸‰ì»·(ì„ íƒ)" />
        </div>
        <div class="row">
          <input id="cut4" type="number" placeholder="4ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut5" type="number" placeholder="5ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut6" type="number" placeholder="6ë“±ê¸‰ì»·(ì„ íƒ)" />
        </div>
        <div class="row">
          <input id="cut7" type="number" placeholder="7ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut8" type="number" placeholder="8ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut9" type="number" placeholder="9ë“±ê¸‰ì»·(ì„ íƒ)" />
        </div>
        <button id="saveStatsBtn" class="ghost" type="button">í†µê³„ ì €ì¥/ì—…ë°ì´íŠ¸</button>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§© ë‹¨ì› ì ìˆ˜ ì…ë ¥(ê·¸ë˜í”„4)</h3>
        <div class="muted">í˜„ì¬ ì„ íƒ(í•™ë…„ë„/ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨)ì— ë‹¨ì› ì ìˆ˜ ì¶”ê°€</div>
        <div class="row">
          <input id="unitName" placeholder="ë‹¨ì›ëª…(ì˜ˆ: ë¬¸í•™/ë¹„ë¬¸í•™, ë¯¸ì ë¶„-ìˆ˜ì—´)" />
          <input id="unitScore" type="number" placeholder="ì ìˆ˜" />
          <input id="unitMax" type="number" placeholder="ë§Œì (ì„ íƒ)" />
          <button id="addUnitBtn" class="ghost" type="button">ë‹¨ì› ì¶”ê°€</button>
        </div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§¨ ì „ì²´ ì´ˆê¸°í™”(ì£¼ì˜)</h3>
        <div class="muted">ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤.</div>
        <button id="resetAllBtn" class="danger" type="button">ì „ì²´ ë°ì´í„° ì‚­ì œ</button>
      </div>
    </div>
  </div>

<script>
/** ==========================================
 *  ëŒ€í•™ ë°ì´í„°(í•˜ë“œì½”ë”©) â€” í•™ë…„ë„ êµ¬ë¶„ ì—†ìŒ
 *  í˜•ì‹: { minPercentile, university, major }
 *  ========================================== */
const UNIVERSITY_DATA = [
  // ì˜ˆì‹œ(ì›í•˜ë©´ ì—¬ê¸°ì— ê³„ì† ì¶”ê°€)
  // { minPercentile: 96, university: "ì„œìš¸ëŒ€", major: "ì»´í“¨í„°ê³µí•™" },
  // { minPercentile: 92, university: "ì—°ì„¸ëŒ€", major: "ê²½ì˜" },
  // { minPercentile: 88, university: "ì¤‘ì•™ëŒ€", major: "í™”í•™" },
];

/** ==========================================
 *  ì¶”ì²œ ë¶„ë¥˜ ê¸°ì¤€(ë„ˆê°€ ë‚˜ì¤‘ì— ìˆ«ìë§Œ ë°”ê¾¸ë©´ ë¨)
 *  diff = ë‚´ë°±ë¶„ìœ„ - í•„ìš”ë°±ë¶„ìœ„
 *  - ì•ˆì •: diff >= SAFE_DIFF
 *  - ì ì •: MATCH_LOW <= diff < SAFE_DIFF  (í˜¹ì€ ë„ˆê°€ ì›í•˜ëŠ” ë²”ìœ„ë¡œ)
 *  - ìƒí–¥: diff < MATCH_LOW
 *  ========================================== */
const SAFE_DIFF  = 4;   // ì˜ˆ: ë‚´ ë°±ë¶„ìœ„ê°€ í•„ìš”ë°±ë¶„ìœ„ë³´ë‹¤ 4 ì´ìƒ ë†’ìœ¼ë©´ ì•ˆì •
const MATCH_LOW  = 0;   // ì˜ˆ: 0~3 ì •ë„ë©´ ì ì •, ìŒìˆ˜ë©´ ìƒí–¥

function classifyUniv(myPct, needPct){
  const diff = Number(myPct) - Number(needPct);
  if(diff >= SAFE_DIFF) return { label:"ì•ˆì •", key:"safe" };
  if(diff >= MATCH_LOW) return { label:"ì ì •", key:"fit" };
  return { label:"ìƒí–¥", key:"reach" };
}

/** =========================
 *  ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° (localStorage)
 *  ========================= */
const STORAGE_KEY = "scoreboard_state_v3";

function defaultState(){
  return {
    users: [], // {id, name, grade, pwHash, createdAt}
    logs: [],  // {time, name, grade}
    types: { "2026": [], "2027": [] }, // {id,name,createdAt}
    rounds: [], // âœ… NEW: {id,year,typeId,subject,round,createdAt}
    scores: [], // {id,year,typeId,subject,round,score,percentile,updatedAt}
    stats: [],  // {id,year,typeId,subject,round,avg,cut1..cut9,updatedAt}
    units: [],  // {id,year,typeId,subject,round,unit,score,maxScore,updatedAt}
  };
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return defaultState();
  try{
    const st = JSON.parse(raw);
    if(!st.types) st.types = { "2026": [], "2027": [] };
    if(!st.users) st.users = [];
    if(!st.logs) st.logs = [];
    if(!st.rounds) st.rounds = [];
    if(!st.scores) st.scores = [];
    if(!st.stats) st.stats = [];
    if(!st.units) st.units = [];
    return st;
  }catch{
    return defaultState();
  }
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function uid(){
  return Math.random().toString(36).slice(2) + Date.now().toString(36);
}

const SUBJECTS = ["êµ­ì–´","ìˆ˜í•™","ì˜ì–´","í™”í•™1","ìƒëª…ê³¼í•™1","í•œêµ­ì‚¬"];
const gradeHierarchy = { "ì˜": 5, "ì¹˜": 4, "í•œ": 3, "ì•½": 2, "ìˆ˜": 1 };

function canViewYear(grade, year){
  if(grade === "ì˜" || grade === "ì¹˜") return true;
  if(grade === "í•œ" || grade === "ì•½" || grade === "ìˆ˜") return year === "2027";
  return false;
}

/** =========================
 *  ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ(SHA-256)
 *  ========================= */
async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
}

/** =========================
 *  ì „ì—­ ìƒíƒœ
 *  ========================= */
let state = loadState();

let currentUser = null; // {id,name,grade}
let currentYear = "2027";

let selectedTypeId = null;
let selectedSubject = SUBJECTS[0];
let selectedRound = null;

let c1=null,c2=null,c3=null,c4=null;

const $ = (id)=>document.getElementById(id);
const escapeHtml = (s)=>String(s??"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

/** =========================
 *  UI í—¬í¼
 *  ========================= */
function show(el, yes){ el.classList.toggle("hidden", !yes); }

function setHello(){
  if(!currentUser) return;
  $("helloLine").textContent = `ì•ˆë…•í•˜ì„¸ìš”, ${currentUser.name}ë‹˜`;
}

function setBadges(){
  $("roleBadge").textContent = `í˜„ì¬ ë“±ê¸‰: ${currentUser.grade}`;
  $("currentGradeLabel").textContent = currentUser.grade;
  $("currentYearLabel").textContent = currentYear;
}

function applyYearTabs(){
  const can26 = canViewYear(currentUser.grade,"2026");
  const can27 = canViewYear(currentUser.grade,"2027");

  $("tab2026").classList.toggle("locked", !can26);
  $("tab2027").classList.toggle("locked", !can27);

  $("tab2026").classList.toggle("active", currentYear==="2026");
  $("tab2027").classList.toggle("active", currentYear==="2027");

  $("currentYearLabel").textContent = currentYear;
}

/** =========================
 *  ì´ˆê¸° í™”ë©´ ê²°ì •
 *  ========================= */
function boot(){
  const hasUsers = state.users.length > 0;
  show($("setupSection"), !hasUsers);
  show($("loginSection"), hasUsers);

  show($("yearWrap"), false);
  show($("pickSection"), false);
  show($("scoreEditorSection"), false);
  show($("chartsSection"), false);
  show($("detailSection"), false);
  show($("manageTab"), false);
  show($("manageSection"), false);
  show($("logoutBtn"), false);
  show($("roleBadge"), false);
  show($("helloLine"), false);
  show($("roundCreateSection"), false);

  if(hasUsers){
    $("pwInput").value = "";
  }
}
boot();

/** =========================
 *  ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ/ë¡œê·¸ ê¸°ë¡
 *  ========================= */
function addLog(name, grade){
  state.logs.push({ time: new Date().toLocaleString(), name, grade });
  saveState();
}

async function loginWithPassword(pw){
  const hash = await sha256(pw);
  const user = state.users.find(u => u.pwHash === hash);
  if(!user) return null;
  return { id:user.id, name:user.name, grade:user.grade };
}

function afterLogin(){
  show($("loginSection"), false);
  show($("setupSection"), false);

  show($("yearWrap"), true);
  show($("pickSection"), true);
  show($("chartsSection"), true);
  show($("detailSection"), true);
  show($("logoutBtn"), true);

  show($("roleBadge"), true);
  show($("helloLine"), true);
  setHello();
  setBadges();

  const isAdmin = currentUser.grade === "ì˜";
  show($("manageTab"), isAdmin);
  show($("scoreEditorSection"), isAdmin);
  show($("roundCreateSection"), isAdmin);

  if(!canViewYear(currentUser.grade, currentYear)){
    currentYear = "2027";
  }
  applyYearTabs();

  renderSubjectButtons();
  renderTypeSelect();
  updatePickLabel();
  renderRoundButtonsFromRounds();
  updateDetail();
  renderAllCharts();

  if(isAdmin){
    renderManageAll();
  }
}

$("logoutBtn").addEventListener("click", ()=>{
  currentUser = null;
  destroyCharts();
  boot();
});

$("loginBtn").addEventListener("click", async ()=>{
  try{
    const pw = $("pwInput").value.trim();
    if(!pw) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.");
    const user = await loginWithPassword(pw);
    if(!user) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");

    currentUser = user;
    addLog(user.name, user.grade);
    afterLogin();
  }catch(e){
    console.error(e);
    alert("ë¡œê·¸ì¸ ì˜¤ë¥˜ê°€ ë‚¬ì–´. (ë¸Œë¼ìš°ì € ì½˜ì†” F12 í™•ì¸)");
  }
});

/** =========================
 *  ìµœì´ˆ ê´€ë¦¬ì ìƒì„±(ì˜)
 *  ========================= */
$("setupBtn").addEventListener("click", async ()=>{
  const name = $("setupName").value.trim();
  const pw = $("setupPw").value.trim();
  if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
  if(!pw) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.");

  const pwHash = await sha256(pw);
  state.users.push({ id: uid(), name, grade: "ì˜", pwHash, createdAt: Date.now() });

  if(state.types["2026"].length === 0){
    state.types["2026"].push({ id: uid(), name: "í•™ë ¥í‰ê°€", createdAt: Date.now() });
    state.types["2026"].push({ id: uid(), name: "ì„œë°”ì´ë²Œ", createdAt: Date.now() });
  }
  if(state.types["2027"].length === 0){
    state.types["2027"].push({ id: uid(), name: "í•™ë ¥í‰ê°€", createdAt: Date.now() });
    state.types["2027"].push({ id: uid(), name: "ì„œë°”ì´ë²Œ", createdAt: Date.now() });
  }
  saveState();
  alert("ê´€ë¦¬ì ìƒì„± ì™„ë£Œ! ì´ì œ ë¡œê·¸ì¸ í™”ë©´ì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•´ì¤˜.");
  boot();
});

/** =========================
 *  í•™ë…„ë„ íƒ­
 *  ========================= */
function handleYearClick(year){
  if(!canViewYear(currentUser.grade, year)){
    alert("ì´ ë“±ê¸‰ì€ í•´ë‹¹ í•™ë…„ë„ ì—´ëŒ ê¶Œí•œì´ ì—†ì–´ìš”.");
    return;
  }
  if(currentYear === year) return;
  currentYear = year;

  selectedTypeId = null;
  selectedRound = null;

  destroyCharts();
  applyYearTabs();

  renderTypeSelect();
  updatePickLabel();
  renderRoundButtonsFromRounds();
  updateDetail();
  renderAllCharts();

  if(currentUser.grade === "ì˜"){
    renderManageAll();
  }
}

$("tab2026").addEventListener("click", ()=>handleYearClick("2026"));
$("tab2027").addEventListener("click", ()=>handleYearClick("2027"));

/** =========================
 *  ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨ ì„ íƒ UI
 *  ========================= */
function renderTypeSelect(){
  const sel = $("typeSelect");
  sel.innerHTML = "";

  const types = state.types[currentYear] || [];
  if(types.length === 0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "ì¢…ë¥˜ ì—†ìŒ(ì˜ê°€ ê´€ë¦¬ì—ì„œ ì¶”ê°€)";
    sel.appendChild(opt);
    sel.disabled = true;
    selectedTypeId = null;
    return;
  }

  sel.disabled = false;
  for(const t of types){
    const opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = t.name;
    sel.appendChild(opt);
  }

  if(!selectedTypeId || !types.some(t=>t.id===selectedTypeId)){
    selectedTypeId = sel.value;
  }else{
    sel.value = selectedTypeId;
  }
}

$("typeSelect").addEventListener("change", ()=>{
  selectedTypeId = $("typeSelect").value;
  selectedRound = null;
  updatePickLabel();
  renderRoundButtonsFromRounds();
  updateDetail();
  renderAllCharts();
});

function renderSubjectButtons(){
  const wrap = $("subjectButtons");
  wrap.innerHTML = "";
  SUBJECTS.forEach(subj=>{
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "ghost";
    btn.textContent = subj;
    btn.onclick = ()=>{
      selectedSubject = subj;
      selectedRound = null;
      markActiveButtons();
      renderRoundButtonsFromRounds();
      updatePickLabel();
      updateDetail();
      renderAllCharts();
    };
    wrap.appendChild(btn);
  });
  markActiveButtons();
}

function markActiveButtons(){
  [...$("subjectButtons").querySelectorAll("button")].forEach(b=>{
    b.classList.toggle("active", b.textContent === selectedSubject);
  });
  [...$("roundButtons").querySelectorAll("button")].forEach(b=>{
    const r = Number(b.dataset.round);
    b.classList.toggle("active", Number.isFinite(r) && r === selectedRound);
  });
}

function getRoundsInScope(){
  if(!selectedTypeId) return [];
  return state.rounds
    .filter(r => r.year===currentYear && r.typeId===selectedTypeId && r.subject===selectedSubject)
    .map(r => Number(r.round))
    .filter(x => Number.isFinite(x))
    .sort((a,b)=>a-b);
}

function ensureRoundExists(roundNumber){
  const r = Number(roundNumber);
  if(!Number.isFinite(r)) return;
  const exists = state.rounds.some(x =>
    x.year===currentYear && x.typeId===selectedTypeId && x.subject===selectedSubject && Number(x.round)===r
  );
  if(exists) return;
  state.rounds.push({
    id: uid(),
    year: currentYear,
    typeId: selectedTypeId,
    subject: selectedSubject,
    round: r,
    createdAt: Date.now()
  });
  saveState();
}

function renderRoundButtonsFromRounds(){
  const wrap = $("roundButtons");
  wrap.innerHTML = "";

  if(!selectedTypeId){
    wrap.innerHTML = `<span class="muted">ì¢…ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜</span>`;
    return;
  }

  const rounds = getRoundsInScope();

  if(rounds.length === 0){
    wrap.innerHTML = `<span class="muted">íšŒì°¨ ì—†ìŒ(ì˜ê°€ íšŒì°¨ ìƒì„±í•˜ë©´ ë²„íŠ¼ì´ ìƒê²¨ìš”)</span>`;
    selectedRound = null;
    markActiveButtons();
    updatePickLabel();
    return;
  }

  rounds.forEach(r=>{
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "ghost";
    btn.textContent = `${r}íšŒ`;
    btn.dataset.round = String(r);
    btn.onclick = ()=>{
      selectedRound = r;
      markActiveButtons();
      updatePickLabel();
      updateDetail();
      renderAllCharts();
    };
    wrap.appendChild(btn);
  });

  if(selectedRound == null || !rounds.includes(selectedRound)){
    selectedRound = rounds[0];
  }
  markActiveButtons();
  updatePickLabel();
}

function updatePickLabel(){
  const typeName = (state.types[currentYear]||[]).find(t=>t.id===selectedTypeId)?.name ?? "-";
  const rnd = (selectedRound == null) ? "-" : `${selectedRound}íšŒ`;
  $("currentPick").textContent = `${currentYear} / ${typeName} / ${selectedSubject} / ${rnd}`;
}

/** =========================
 *  íšŒì°¨ ìƒì„±/ì‚­ì œ (ì˜ ì „ìš©)
 *  ========================= */
$("addRoundBtn").addEventListener("click", ()=>{
  if(!currentUser || currentUser.grade!=="ì˜") return;
  if(!selectedTypeId) return alert("ì¢…ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");
  const v = Number(($("newRoundInput").value||"").trim());
  if(!Number.isFinite(v) || v<=0) return alert("íšŒì°¨ëŠ” 1 ì´ìƒì˜ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜.");

  ensureRoundExists(v);
  $("newRoundInput").value = "";
  renderRoundButtonsFromRounds();
  updateDetail();
  renderAllCharts();
});

$("delRoundBtn").addEventListener("click", ()=>{
  if(!currentUser || currentUser.grade!=="ì˜") return;
  if(!selectedTypeId || selectedRound==null) return alert("ì‚­ì œí•  íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");

  const r = Number(selectedRound);

  // ì´ íšŒì°¨ì— ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚­ì œ ë§‰ê¸°(ì•ˆì „ì¥ì¹˜)
  const hasScore = state.scores.some(s => s.year===currentYear && s.typeId===selectedTypeId && s.subject===selectedSubject && Number(s.round)===r);
  const hasStat  = state.stats.some(s => s.year===currentYear && s.typeId===selectedTypeId && s.subject===selectedSubject && Number(s.round)===r);
  const hasUnit  = state.units.some(u => u.year===currentYear && u.typeId===selectedTypeId && u.subject===selectedSubject && Number(u.round)===r);

  if(hasScore || hasStat || hasUnit){
    return alert("ì´ íšŒì°¨ì— ì ìˆ˜/í†µê³„/ë‹¨ì› ë°ì´í„°ê°€ ìˆì–´ì„œ ì‚­ì œí•  ìˆ˜ ì—†ì–´ìš”. (ë¨¼ì € ë°ì´í„° ì‚­ì œ í•„ìš”)");
  }

  state.rounds = state.rounds.filter(x =>
    !(x.year===currentYear && x.typeId===selectedTypeId && x.subject===selectedSubject && Number(x.round)===r)
  );
  saveState();

  selectedRound = null;
  renderRoundButtonsFromRounds();
  updateDetail();
  renderAllCharts();
});

/** =========================
 *  ì ìˆ˜/í†µê³„/ë‹¨ì›/ëŒ€í•™ ë°ì´í„° ì½ê¸°
 *  ========================= */
function getScoresInScope(){
  return state.scores.filter(s => s.year === currentYear);
}

function getMyScoreDoc(){
  if(!selectedTypeId || selectedRound==null) return null;
  return getScoresInScope().find(s =>
    s.typeId===selectedTypeId && s.subject===selectedSubject && Number(s.round)===Number(selectedRound)
  ) ?? null;
}

function getStatDoc(){
  if(!selectedTypeId || selectedRound==null) return null;
  return state.stats.find(s =>
    s.year===currentYear && s.typeId===selectedTypeId && s.subject===selectedSubject && Number(s.round)===Number(selectedRound)
  ) ?? null;
}

function getUnitDocs(){
  if(!selectedTypeId || selectedRound==null) return [];
  return state.units
    .filter(u => u.year===currentYear && u.typeId===selectedTypeId && u.subject===selectedSubject && Number(u.round)===Number(selectedRound))
    .slice()
    .sort((a,b)=>(a.unit||"").localeCompare(b.unit||"", "ko"));
}

/** =========================
 *  ìƒì„¸ í‘œì‹œ + ëŒ€í•™ ì¹´ë“œ
 *  ========================= */
function updateDetail(){
  const my = getMyScoreDoc();
  $("myScoreLabel").textContent = my ? String(my.score) : "-";
  $("myPctLabel").textContent = (my && my.percentile!=null) ? String(my.percentile) : "-";

  const st = getStatDoc();
  $("avgLabel").textContent = (st && st.avg!=null) ? String(st.avg) : "-";

  const ud = getUnitDocs();
  const tb = $("unitTable");
  tb.innerHTML = "";
  if(ud.length === 0){
    tb.innerHTML = `<tr><td colspan="3" class="muted">ë‹¨ì› ë°ì´í„° ì—†ìŒ(ì˜ê°€ ê´€ë¦¬ì—ì„œ ì¶”ê°€)</td></tr>`;
  }else{
    ud.forEach(x=>{
      tb.innerHTML += `<tr><td>${escapeHtml(x.unit)}</td><td>${x.score ?? "-"}</td><td>${x.maxScore ?? "-"}</td></tr>`;
    });
  }

  renderUniversityCards();
}

function renderUniversityCards(){
  const box = $("univCards");
  if(!box) return;

  if(!currentUser || gradeHierarchy[currentUser.grade] < gradeHierarchy["í•œ"]){
    box.innerHTML = `<div class="muted">í•œ ë“±ê¸‰ ì´ìƒë¶€í„° ëŒ€í•™ ì¶”ì²œì„ ë³¼ ìˆ˜ ìˆì–´ìš”.</div>`;
    return;
  }

  const my = getMyScoreDoc();
  const myPct = my?.percentile;
  if(myPct == null || !Number.isFinite(Number(myPct))){
    box.innerHTML = `<div class="muted">ë‚´ ë°±ë¶„ìœ„ë¥¼ ì €ì¥í•˜ë©´ ì¶”ì²œì´ ë– ìš”.</div>`;
    return;
  }

  const pct = Number(myPct);

  if(!Array.isArray(UNIVERSITY_DATA) || UNIVERSITY_DATA.length === 0){
    box.innerHTML = `<div class="muted">ëŒ€í•™ ë°ì´í„°ê°€ ì•„ì§ ì—†ì–´ìš”. (ì½”ë“œì˜ UNIVERSITY_DATAì— ì¶”ê°€í•˜ë©´ ë³´ì—¬ìš”)</div>`;
    return;
  }

  // ìš°ì„  í•„ìš”í•œ ë°±ë¶„ìœ„ê°€ ë‚´ ë°±ë¶„ìœ„ë³´ë‹¤ í° ê²ƒë„(ìƒí–¥) í¬í•¨í•´ì„œ ë³´ì—¬ì£¼ë˜,
  // ë¶„ë¥˜(ìƒí–¥/ì ì •/ì•ˆì •)ë³„ë¡œ ë¬¶ì–´ì„œ ë³´ì—¬ì¤Œ
  const prepared = UNIVERSITY_DATA
    .map(u => ({
      minPercentile: Number(u.minPercentile),
      university: String(u.university||""),
      major: String(u.major||""),
    }))
    .filter(u => Number.isFinite(u.minPercentile) && u.university)
    .map(u => ({ ...u, cls: classifyUniv(pct, u.minPercentile) }));

  // ê·¸ë£¹í•‘
  const groupOrder = ["reach","fit","safe"]; // ìƒí–¥ -> ì ì • -> ì•ˆì • (ì›í•˜ë©´ ìˆœì„œ ë°”ê¿”ë„ ë¨)
  const groupName = { reach:"ìƒí–¥", fit:"ì ì •", safe:"ì•ˆì •" };

  const groups = {
    reach: prepared.filter(x=>x.cls.key==="reach").sort((a,b)=>b.minPercentile-a.minPercentile).slice(0,8),
    fit:   prepared.filter(x=>x.cls.key==="fit").sort((a,b)=>b.minPercentile-a.minPercentile).slice(0,8),
    safe:  prepared.filter(x=>x.cls.key==="safe").sort((a,b)=>b.minPercentile-a.minPercentile).slice(0,8),
  };

  // ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´
  const total = groups.reach.length + groups.fit.length + groups.safe.length;
  if(total === 0){
    box.innerHTML = `<div class="muted">ì¶”ì²œí•  ëŒ€í•™ ë°ì´í„°ê°€ ì—†ì–´ìš”.</div>`;
    return;
  }

  box.innerHTML = groupOrder.map(key=>{
    const list = groups[key];
    if(list.length===0) return "";
    return `
      <div class="card" style="grid-column: 1 / -1; border:1px solid #eef2ff; background:#fafbff">
        <div class="t">ğŸŸ¦ ${groupName[key]}</div>
        <div class="muted">ë‚´ ë°±ë¶„ìœ„: ${pct} / ê¸°ì¤€ì€ ë‚˜ì¤‘ì— ë°”ê¿€ ìˆ˜ ìˆì–´ìš”</div>
      </div>
      ${list.map(u=>`
        <div class="card">
          <div class="t">${escapeHtml(u.university)}${u.major?` Â· ${escapeHtml(u.major)}`:""}</div>
          <div class="d">í•„ìš” ë°±ë¶„ìœ„: <b>${u.minPercentile}</b></div>
        </div>
      `).join("")}
    `;
  }).join("");
}

/** =========================
 *  ì°¨íŠ¸
 *  ========================= */
function destroyCharts(){
  if(c1) c1.destroy(); if(c2) c2.destroy(); if(c3) c3.destroy(); if(c4) c4.destroy();
  c1=c2=c3=c4=null;
}

function renderChart1(){
  const rows = getScoresInScope()
    .filter(s => s.typeId===selectedTypeId && s.subject===selectedSubject)
    .map(s => ({ r:Number(s.round), v:Number(s.score) }))
    .filter(x => Number.isFinite(x.r) && Number.isFinite(x.v))
    .sort((a,b)=>a.r-b.r);

  const labels = rows.map(x=>`${x.r}íšŒ`);
  const values = rows.map(x=>x.v);

  c1 = new Chart($("chart1").getContext("2d"),{
    type:"line",
    data:{labels,datasets:[{label:`${selectedSubject} ì ìˆ˜`,data:values,fill:false}]},
    options:{
      responsive:true,
      scales:{
        y:{ min:0, max:100 } // âœ… ê·¸ë˜í”„1 Yì¶• 0~100 ê³ ì •
      }
    }
  });
}

function renderChart2(){
  const typesMap = new Map((state.types[currentYear]||[]).map(t=>[t.id,t.name]));
  const rows = getScoresInScope()
    .filter(s => s.subject===selectedSubject)
    .slice()
    .sort((a,b)=>(a.updatedAt||0)-(b.updatedAt||0));

  const labels = rows.map(s=>{
    const tn = typesMap.get(s.typeId) || "?";
    return `${tn} ${s.round}íšŒ`;
  });
  const values = rows.map(s=>Number(s.score));

  c2 = new Chart($("chart2").getContext("2d"),{
    type:"line",
    data:{labels,datasets:[{label:`ì „ì²´ ${selectedSubject} ì¶”ì´`,data:values,fill:false}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });
}

function renderChart3(){
  const my = getMyScoreDoc();
  const st = getStatDoc();
  const myScore = my ? Number(my.score) : null;
  const avg = (st && st.avg!=null) ? Number(st.avg) : null;

  const labels = [];
  const values = [];
  if(myScore!=null && Number.isFinite(myScore)){ labels.push("ë‚´ ì ìˆ˜"); values.push(myScore); }
  if(avg!=null && Number.isFinite(avg)){ labels.push("í‰ê· "); values.push(avg); }

  const cuts = [];
  if(st){
    for(let i=1;i<=9;i++){
      const v = st["cut"+i];
      if(v!=null && v!=="" && Number.isFinite(Number(v))) cuts.push({grade:i, value:Number(v)});
    }
  }

  c3 = new Chart($("chart3").getContext("2d"),{
    type:"bar",
    data:{labels,datasets:[{label:`${selectedSubject} ë¹„êµ`,data:values}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}},
    plugins:[{
      id:"cutLines",
      afterDatasetsDraw(chart){
        const {ctx,chartArea:{left,right},scales:{y}}=chart;
        ctx.save();
        ctx.setLineDash([6,6]);
        ctx.lineWidth=1;
        cuts.forEach(c=>{
          const yPos = y.getPixelForValue(c.value);
          ctx.beginPath(); ctx.moveTo(left,yPos); ctx.lineTo(right,yPos); ctx.stroke();
          ctx.setLineDash([]);
          ctx.fillStyle="#374151";
          ctx.font="12px system-ui";
          ctx.fillText(`${c.grade}ì»· ${c.value}`, left+6, yPos-4);
          ctx.setLineDash([6,6]);
        });
        ctx.restore();
      }
    }]
  });
}

function renderChart4(){
  const ud = getUnitDocs();
  const labels = ud.map(x=>x.unit);
  const values = ud.map(x=>Number(x.score));
  c4 = new Chart($("chart4").getContext("2d"),{
    type:"bar",
    data:{labels,datasets:[{label:`ë‹¨ì›ë³„ ${selectedSubject}`,data:values}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });
}

function renderAllCharts(){
  destroyCharts();
  if(!selectedTypeId) return;
  renderChart1();
  renderChart2();
  renderChart3();
  renderChart4();
}

/** =========================
 *  ì˜ ì „ìš©: ì ìˆ˜ ì €ì¥/ì—…ë°ì´íŠ¸
 *  ========================= */
$("saveScoreBtn").addEventListener("click", ()=>{
  if(!currentUser || currentUser.grade !== "ì˜") return;

  if(!selectedTypeId || selectedRound==null){
    alert("ì¢…ë¥˜/íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜. (íšŒì°¨ê°€ ì—†ìœ¼ë©´ ë¨¼ì € íšŒì°¨ ìƒì„±!)");
    return;
  }

  const score = parseInt($("scoreInput").value,10);
  if(Number.isNaN(score)) return alert("ì ìˆ˜ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜.");

  const pctRaw = $("percentileInput").value.trim();
  const percentile = (pctRaw==="") ? null : parseInt(pctRaw,10);

  // âœ… ì•ˆì „: ì ìˆ˜ ì €ì¥ ì‹œ íšŒì°¨ê°€ state.roundsì— ì—†ìœ¼ë©´ ìë™ ìƒì„±
  ensureRoundExists(selectedRound);

  const existing = getMyScoreDoc();
  if(existing){
    existing.score = score;
    existing.percentile = percentile;
    existing.updatedAt = Date.now();
  }else{
    state.scores.push({
      id: uid(),
      year: currentYear,
      typeId: selectedTypeId,
      subject: selectedSubject,
      round: Number(selectedRound),
      score,
      percentile,
      updatedAt: Date.now()
    });
  }

  saveState();
  $("scoreInput").value="";
  $("percentileInput").value="";

  renderRoundButtonsFromRounds();
  updatePickLabel();
  updateDetail();
  renderAllCharts();

  if(currentUser.grade==="ì˜") renderManageAll();
});

/** =========================
 *  ê´€ë¦¬(ì˜ ì „ìš©)
 *  ========================= */
$("manageTab").addEventListener("click", ()=>{
  if(!currentUser || currentUser.grade!=="ì˜") return;
  $("manageSection").classList.toggle("hidden");
  renderManageAll();
  $("manageSection").scrollIntoView({behavior:"smooth", block:"start"});
});

function renderManageAll(){
  renderTypeList();
  renderUserList();
  renderLogs();
}

function renderTypeList(){
  const wrap = $("typeList");
  const list = state.types[currentYear] || [];
  if(list.length===0){ wrap.textContent="ë“±ë¡ëœ ì¢…ë¥˜ ì—†ìŒ"; return; }

  wrap.innerHTML = list.map(t=>`
    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin:6px 0;">
      <div>â€¢ <b>${escapeHtml(t.name)}</b></div>
      <button class="danger" type="button" data-deltype="${t.id}">ì‚­ì œ</button>
    </div>
  `).join("");

  wrap.querySelectorAll("button[data-deltype]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-deltype");
      const hasScore = state.scores.some(s=>s.year===currentYear && s.typeId===id);
      const hasRound = state.rounds.some(r=>r.year===currentYear && r.typeId===id);
      if(hasScore || hasRound) return alert("ì´ ì¢…ë¥˜ë¡œ ì €ì¥ëœ íšŒì°¨/ì ìˆ˜ê°€ ìˆì–´ì„œ ì‚­ì œ ë¶ˆê°€(ë°ì´í„° ë¨¼ì € ì‚­ì œí•´ì•¼ í•¨)");
      state.types[currentYear] = (state.types[currentYear]||[]).filter(x=>x.id!==id);
      saveState();
      renderTypeSelect();
      renderTypeList();
    });
  });
}

$("addTypeBtn").addEventListener("click", ()=>{
  if(!currentUser || currentUser.grade!=="ì˜") return;
  const name = $("newTypeInput").value.trim();
  if(!name) return alert("ì¢…ë¥˜ ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
  const list = state.types[currentYear] || [];
  if(list.some(t=>t.name===name)) return alert("ì´ë¯¸ ìˆëŠ” ì¢…ë¥˜ì•¼.");
  list.push({ id: uid(), name, createdAt: Date.now() });
  state.types[currentYear] = list;
  saveState();
  $("newTypeInput").value="";
  renderTypeSelect();
  renderTypeList();
});

async function addUser(){
  const name = $("newUserName").value.trim();
  const pw = $("newPw").value.trim();
  const grade = $("newGrade").value;
  if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
  if(!pw) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.");

  const pwHash = await sha256(pw);
  state.users.push({ id: uid(), name, grade, pwHash, createdAt: Date.now() });
  saveState();
  $("newUserName").value="";
  $("newPw").value="";
  renderUserList();
}

$("addUserBtn").addEventListener("click", ()=>{ addUser(); });

function renderUserList(){
  const wrap = $("userList");
  wrap.innerHTML = "";
  state.users.forEach(u=>{
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="t">${escapeHtml(u.name)}</div>
      <div class="d">ë“±ê¸‰: <b>${escapeHtml(u.grade)}</b></div>
      <button class="danger" type="button" data-deluser="${u.id}" style="margin-top:8px">ì‚­ì œ</button>
    `;
    wrap.appendChild(div);
  });

  wrap.querySelectorAll("button[data-deluser]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-deluser");
      if(state.users.length===1) return alert("ìµœì†Œ 1ëª…(ê´€ë¦¬ì)ì€ ë‚¨ê²¨ì•¼ í•´.");
      state.users = state.users.filter(u=>u.id!==id);
      saveState();
      renderUserList();
    });
  });
}

function renderLogs(){
  const box = $("loginRecords");
  if(state.logs.length===0){ box.textContent="ê¸°ë¡ ì—†ìŒ"; return; }
  // âœ… ì˜ê°€ ì§€ì •í•œ ì´ë¦„(name) ê·¸ëŒ€ë¡œ í‘œì‹œ
  box.innerHTML = state.logs.slice().reverse()
    .map(l=>`â€¢ [${escapeHtml(l.time)}] ${escapeHtml(l.name)} (${escapeHtml(l.grade)})`)
    .join("<br/>");
}

$("clearLogsBtn").addEventListener("click", ()=>{
  if(!currentUser || currentUser.grade!=="ì˜") return;
  state.logs = [];
  saveState();
  renderLogs();
});

/** í†µê³„ ì €ì¥/ì—…ë°ì´íŠ¸ */
$("saveStatsBtn").addEventListener("click", ()=>{
  if(!currentUser || currentUser.grade!=="ì˜") return;
  if(!selectedTypeId || selectedRound==null) return alert("ì¢…ë¥˜/íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜. (íšŒì°¨ê°€ ì—†ìœ¼ë©´ ë¨¼ì € íšŒì°¨ ìƒì„±!)");

  // âœ… ì•ˆì „: í†µê³„ ì €ì¥ ì‹œ íšŒì°¨ ìë™ ìƒì„±
  ensureRoundExists(selectedRound);

  const avgRaw = $("statAvg").value.trim();
  const avg = (avgRaw==="") ? null : Number(avgRaw);

  const data = {
    id: uid(),
    year: currentYear,
    typeId: selectedTypeId,
    subject: selectedSubject,
    round: Number(selectedRound),
    avg: (avg==null || Number.isNaN(avg)) ? null : avg,
    updatedAt: Date.now()
  };

  for(let i=1;i<=9;i++){
    const v = $("cut"+i).value.trim();
    data["cut"+i] = (v==="") ? null : Number(v);
    if(Number.isNaN(data["cut"+i])) data["cut"+i]=null;
  }

  const existing = getStatDoc();
  if(existing){
    Object.assign(existing, data);
    existing.id = existing.id; // ìœ ì§€
  }else{
    state.stats.push(data);
  }

  state.stats = state.stats.filter((s, idx, arr)=>{
    const same = arr.findIndex(x => x.year===s.year && x.typeId===s.typeId && x.subject===s.subject && Number(x.round)===Number(s.round));
    return same === idx;
  });

  saveState();
  updateDetail();
  renderAllCharts();
});

/** ë‹¨ì› ì¶”ê°€ */
$("addUnitBtn").addEventListener("click", ()=>{
  if(!currentUser || currentUser.grade!=="ì˜") return;
  if(!selectedTypeId || selectedRound==null) return alert("ì¢…ë¥˜/íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜. (íšŒì°¨ê°€ ì—†ìœ¼ë©´ ë¨¼ì € íšŒì°¨ ìƒì„±!)");

  // âœ… ì•ˆì „: ë‹¨ì› ì €ì¥ ì‹œ íšŒì°¨ ìë™ ìƒì„±
  ensureRoundExists(selectedRound);

  const unit = $("unitName").value.trim();
  const scoreRaw = $("unitScore").value.trim();
  const maxRaw = $("unitMax").value.trim();

  if(!unit) return alert("ë‹¨ì›ëª…ì„ ì…ë ¥í•´ì¤˜.");
  const score = Number(scoreRaw);
  if(!Number.isFinite(score)) return alert("ë‹¨ì› ì ìˆ˜ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜.");

  const maxScore = (maxRaw==="") ? null : Number(maxRaw);

  state.units.push({
    id: uid(),
    year: currentYear,
    typeId: selectedTypeId,
    subject: selectedSubject,
    round: Number(selectedRound),
    unit,
    score,
    maxScore: (maxScore!=null && Number.isFinite(maxScore)) ? maxScore : null,
    updatedAt: Date.now()
  });

  saveState();
  $("unitName").value="";
  $("unitScore").value="";
  $("unitMax").value="";
  updateDetail();
  renderAllCharts();
});

/** ì „ì²´ ì´ˆê¸°í™” */
$("resetAllBtn").addEventListener("click", ()=>{
  if(!currentUser || currentUser.grade!=="ì˜") return;
  if(!confirm("ì§„ì§œë¡œ ì „ì²´ ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = loadState();
  currentUser = null;
  destroyCharts();
  alert("ì‚­ì œ ì™„ë£Œ. ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤.");
  boot();
});
</script>
</body>
</html>
