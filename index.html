<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ScoreBoard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; background:linear-gradient(135deg,#111827,#4f46e5); margin:0; padding:20px}
    .container{max-width:1100px;margin:auto;background:#fff;padding:22px 22px 28px;border-radius:18px;box-shadow:0 15px 40px rgba(0,0,0,.25);position:relative}
    h1{margin:6px 0 12px;text-align:center}
    .top-right{position:absolute;top:14px;right:16px;display:flex;gap:10px;align-items:center}
    .link-btn{font-size:12px;color:#4f46e5;cursor:pointer;user-select:none;background:none;border:none}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;margin:6px 0}
    .section{margin-top:16px;padding:14px;border:1px solid #eef2ff;border-radius:14px;background:#fafbff}
    .section h3{margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px;margin:6px 0;box-sizing:border-box;border-radius:10px;border:1px solid #d1d5db}
    input,select{width:100%}
    .row > *{flex:1 1 180px}
    button{background:#4f46e5;color:#fff;border:none;cursor:pointer;font-weight:700}
    button:hover{background:#4338ca}
    .ghost{background:#111827}
    .ghost:hover{background:#0b1220}
    .danger{background:#dc2626}
    .danger:hover{background:#b91c1c}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px}
    .muted{color:#6b7280;font-size:12px}
    .hidden{display:none !important}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .grid4{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width: 900px){.grid2,.grid4{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:12px}
    .card .t{font-weight:800;margin-bottom:4px}
    .card .d{font-size:13px;color:#374151}
    canvas{margin-top:10px}
    .btnbar{display:flex;gap:8px;flex-wrap:wrap}
    .btnbar button{width:auto;padding:8px 12px;border-radius:999px}
    .btnbar .active{outline:3px solid #c7d2fe}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:12px;overflow:hidden}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:center}
    th{background:#f3f4f6}
    .mini{font-size:12px}
  </style>
</head>

<body>
  <div class="container">
    <div class="top-right">
      <button id="manageTab" class="link-btn hidden" type="button">ê´€ë¦¬</button>
      <button id="logoutBtn" class="link-btn hidden" type="button">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <h1>ğŸ“Š ScoreBoard</h1>
    <div id="roleBadge" class="badge hidden"></div>

    <!-- ë¡œê·¸ì¸ -->
    <div id="loginSection" class="section">
      <h3>ğŸ” ë¡œê·¸ì¸</h3>
      <input id="pwInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
      <button id="loginBtn">ë¡œê·¸ì¸</button>
    </div>

    <!-- ì„ íƒ UI -->
    <div id="pickSection" class="section hidden">
      <h3>ğŸ§­ ì„ íƒ</h3>

      <div class="row">
        <div style="flex:2 1 360px">
          <div class="muted">ì¢…ë¥˜ ì„ íƒ</div>
          <select id="typeSelect"></select>
        </div>
        <div style="flex:3 1 420px">
          <div class="muted">í˜„ì¬ ì„ íƒ</div>
          <div class="pill" id="currentPick">-</div>
        </div>
      </div>

      <div class="muted" style="margin-top:6px">ê³¼ëª© ì„ íƒ(ë²„íŠ¼)</div>
      <div id="subjectButtons" class="btnbar"></div>

      <div class="muted" style="margin-top:10px">íšŒì°¨ ì„ íƒ(ìë™ ë²„íŠ¼)</div>
      <div id="roundButtons" class="btnbar"></div>
    </div>

    <!-- ì ìˆ˜ ì…ë ¥(ì˜ë§Œ) -->
    <div id="scoreEditorSection" class="section hidden">
      <h3>âœï¸ ì ìˆ˜ ì…ë ¥ (ì˜ ì „ìš©)</h3>
      <div class="row">
        <input id="scoreInput" type="number" placeholder="ì ìˆ˜" />
        <input id="percentileInput" type="number" placeholder="ë°±ë¶„ìœ„(ì„ íƒ)" min="0" max="100" />
        <button id="saveScoreBtn" type="button">ì €ì¥/ì—…ë°ì´íŠ¸</button>
      </div>
      <div class="muted">* (ì„ íƒí•œ ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨) ì¡°í•©ì´ ì´ë¯¸ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ì €ì¥</div>
    </div>

    <!-- ê·¸ë˜í”„ 4ê°œ -->
    <div id="chartsSection" class="section hidden">
      <h3>ğŸ“ˆ ê·¸ë˜í”„</h3>

      <div class="grid4">
        <div class="card">
          <div class="t">ê·¸ë˜í”„ 1) ì„ íƒí•œ ì¢…ë¥˜ì˜ í•´ë‹¹ ê³¼ëª© ê²½í–¥</div>
          <div class="d mini">Xì¶•=íšŒì°¨, Yì¶•=ì ìˆ˜ (ì„ íƒí•œ ê³¼ëª© 1ê°œë§Œ)</div>
          <canvas id="chart1"></canvas>
        </div>

        <div class="card">
          <div class="t">ê·¸ë˜í”„ 2) ë‚´ ëª¨ë“  ì‹œí—˜ì—ì„œ í•´ë‹¹ ê³¼ëª© ê²½í–¥</div>
          <div class="d mini">ì¢…ë¥˜ ìƒê´€ì—†ì´ ì„ íƒ ê³¼ëª©ë§Œ ëª¨ì•„ì„œ</div>
          <canvas id="chart2"></canvas>
        </div>

        <div class="card">
          <div class="t">ê·¸ë˜í”„ 3) í•´ë‹¹ ì‹œí—˜ì—ì„œ ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ ë¹„êµ</div>
          <div class="d mini">ì˜ê°€ ì…ë ¥í•œ í‰ê· /ë“±ê¸‰ì»·ê³¼ ë¹„êµ</div>
          <canvas id="chart3"></canvas>
        </div>

        <div class="card">
          <div class="t">ê·¸ë˜í”„ 4) ë‹¨ì›ë³„ ì ìˆ˜ ë¹„êµ</div>
          <div class="d mini">ì˜ê°€ ì…ë ¥í•œ ë‹¨ì› ì ìˆ˜</div>
          <canvas id="chart4"></canvas>
        </div>
      </div>
    </div>

    <!-- í‘œ(ì„ íƒ ì¡°í•© ì ìˆ˜ + í†µê³„/ë‹¨ì›) -->
    <div id="detailSection" class="section hidden">
      <h3>ğŸ“Œ ì„ íƒ ìƒì„¸</h3>

      <div class="grid2">
        <div class="card">
          <div class="t">ë‚´ ì ìˆ˜(ì„ íƒ ì¡°í•©)</div>
          <div class="d">ì ìˆ˜: <b id="myScoreLabel">-</b> / ë°±ë¶„ìœ„: <b id="myPctLabel">-</b></div>
          <div class="muted">* (ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨) ì„ íƒí–ˆì„ ë•Œ í‘œì‹œ</div>
        </div>

        <div class="card">
          <div class="t">ì‹œí—˜ í†µê³„(ë‹¤ë¥¸ì‚¬ëŒ ë¹„êµìš©)</div>
          <div class="d">í‰ê· : <b id="avgLabel">-</b></div>
          <div class="muted">* ë“±ê¸‰ì»·ì€ ê·¸ë˜í”„3ì— ì„ ìœ¼ë¡œ í‘œì‹œ</div>
        </div>
      </div>

      <div class="section" style="background:#fff;margin-top:12px">
        <h3 style="margin:0 0 8px">ë‹¨ì›ë³„ ì ìˆ˜</h3>
        <table>
          <thead><tr><th>ë‹¨ì›</th><th>ì ìˆ˜</th><th>ë§Œì </th></tr></thead>
          <tbody id="unitTable"></tbody>
        </table>
      </div>
    </div>

    <!-- ê´€ë¦¬(ì˜ ì „ìš©) -->
    <div id="manageSection" class="section hidden">
      <h3>ğŸ›  ê´€ë¦¬ (ì˜ ì „ìš©)</h3>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§© ì¢…ë¥˜ ê´€ë¦¬</h3>
        <div class="row">
          <input id="newTypeInput" placeholder="ìƒˆ ì¢…ë¥˜ ì´ë¦„ (ì˜ˆ: í•™ë ¥í‰ê°€, ì„œë°”ì´ë²Œ)" />
          <button id="addTypeBtn" class="ghost" type="button">ì¢…ë¥˜ ì¶”ê°€</button>
        </div>
        <div id="typeList" class="muted"></div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ‘¤ ë¹„ë°€ë²ˆí˜¸/ë“±ê¸‰ ë§Œë“¤ê¸°</h3>
        <div class="row">
          <input id="newPw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸(ì‚¬ëŒë³„ë¡œ)" />
          <select id="newGrade">
            <option value="ì¹˜">ì¹˜</option>
            <option value="í•œ">í•œ</option>
            <option value="ì•½">ì•½</option>
            <option value="ìˆ˜">ìˆ˜</option>
            <option value="ì˜">ì˜</option>
          </select>
          <button id="addUserBtn" class="ghost" type="button">ì¶”ê°€</button>
        </div>
        <div class="muted">* ì˜ ë“±ê¸‰ì€ ê´€ë¦¬ì—ì„œ ë¹„ë°€ë²ˆí˜¸ ì›ë¬¸ í™•ì¸ ê°€ëŠ¥</div>
        <div id="userList" style="margin-top:10px"></div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§¾ ë¡œê·¸ì¸ ê¸°ë¡</h3>
        <div id="loginRecords" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
        <button id="clearLogsBtn" class="danger" type="button">ë¡œê·¸ì¸ ê¸°ë¡ ì „ì²´ ì‚­ì œ</button>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ“Š ì‹œí—˜ í†µê³„ ì…ë ¥(ê·¸ë˜í”„3)</h3>
        <div class="muted">í˜„ì¬ ì„ íƒ(ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨)ì— ëŒ€í•´ í‰ê· /ë“±ê¸‰ì»·ì„ ì €ì¥</div>
        <div class="row">
          <input id="statAvg" type="number" placeholder="í‰ê· (ì˜ˆ: 78)" />
          <input id="cut1" type="number" placeholder="1ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut2" type="number" placeholder="2ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut3" type="number" placeholder="3ë“±ê¸‰ì»·(ì„ íƒ)" />
        </div>
        <div class="row">
          <input id="cut4" type="number" placeholder="4ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut5" type="number" placeholder="5ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut6" type="number" placeholder="6ë“±ê¸‰ì»·(ì„ íƒ)" />
        </div>
        <div class="row">
          <input id="cut7" type="number" placeholder="7ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut8" type="number" placeholder="8ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut9" type="number" placeholder="9ë“±ê¸‰ì»·(ì„ íƒ)" />
        </div>
        <button id="saveStatsBtn" class="ghost" type="button">í†µê³„ ì €ì¥/ì—…ë°ì´íŠ¸</button>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§© ë‹¨ì› ì ìˆ˜ ì…ë ¥(ê·¸ë˜í”„4)</h3>
        <div class="muted">í˜„ì¬ ì„ íƒ(ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨)ì— ëŒ€í•´ ë‹¨ì› ì ìˆ˜ ì¶”ê°€</div>
        <div class="row">
          <input id="unitName" placeholder="ë‹¨ì›ëª…(ì˜ˆ: ë¬¸í•™/ë¹„ë¬¸í•™, ë¯¸ì ë¶„-ìˆ˜ì—´)" />
          <input id="unitScore" type="number" placeholder="ì ìˆ˜" />
          <input id="unitMax" type="number" placeholder="ë§Œì (ì„ íƒ)" />
          <button id="addUnitBtn" class="ghost" type="button">ë‹¨ì› ì¶”ê°€</button>
        </div>
        <div class="muted">* ë‹¨ì›ì€ ì—¬ëŸ¬ ê°œ ìŒ“ì„(ì‚­ì œ ê¸°ëŠ¥ì€ ë‹¤ìŒì— ì¶”ê°€ ê°€ëŠ¥)</div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import {
    getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc,
    onSnapshot, query, orderBy, serverTimestamp, getDocs, limit, where
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  // âœ… ë„ˆ Firebase ê°’ (ì´ë¯¸ ë„ˆê°€ ì“°ë˜ ê·¸ëŒ€ë¡œ)
  const firebaseConfig = {
    apiKey: "AIzaSyCuMFRksmpH0TuNqv3YoMa76DAAN4r3B84",
    authDomain: "scoreboard-d4bf9.firebaseapp.com",
    projectId: "scoreboard-d4bf9",
    storageBucket: "scoreboard-d4bf9.firebasestorage.app",
    messagingSenderId: "272482248722",
    appId: "1:272482248722:web:81147fe66081feb9da50cb",
    measurementId: "G-VC1922P5SV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ì»¬ë ‰ì…˜
  const colTypes  = collection(db, "sb_types");
  const colScores = collection(db, "sb_scores");      // ë‚´ ì ìˆ˜ (typeId, subject, round, score, percentile)
  const colUsers  = collection(db, "sb_users");
  const colLogs   = collection(db, "sb_logs");
  const colStats  = collection(db, "sb_exam_stats");  // ë‹¤ë¥¸ì‚¬ëŒ ë¹„êµ(í‰ê· /ë“±ê¸‰ì»·)
  const colUnits  = collection(db, "sb_unit_scores"); // ë‹¨ì›ë³„ ì ìˆ˜

  // ë“±ê¸‰
  const gradeHierarchy = { "ì˜": 5, "ì¹˜": 4, "í•œ": 3, "ì•½": 2, "ìˆ˜": 1 };

  // ê³¼ëª©(ê³ ì •)
  const SUBJECTS = ["êµ­ì–´","ìˆ˜í•™","ì˜ì–´","í™”í•™1","ìƒëª…ê³¼í•™1","í•œêµ­ì‚¬"];

  // ìƒíƒœ
  let currentGrade = null;

  let types = [];   // {id,name}
  let users = [];   // {id,password,grade}
  let logs  = [];   // {id,grade,time}
  let scores = [];  // {id,typeId,round,subject,score,percentile,createdAt}
  let stats = [];   // {id,typeId,round,subject,avg,cut1..cut9}
  let units = [];   // {id,typeId,round,subject,unit,score,maxScore}

  // ì„ íƒ ìƒíƒœ
  let selectedTypeId = null;
  let selectedSubject = null;
  let selectedRound = null;

  // ì°¨íŠ¸
  let c1=null, c2=null, c3=null, c4=null;

  const $ = (id) => document.getElementById(id);
  const escapeHtml = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  // ===== ê¶Œí•œ ì ìš© =====
  function applyPermissions() {
    $("loginSection").classList.add("hidden");
    $("pickSection").classList.remove("hidden");
    $("chartsSection").classList.remove("hidden");
    $("detailSection").classList.remove("hidden");
    $("logoutBtn").classList.remove("hidden");

    $("roleBadge").classList.remove("hidden");
    $("roleBadge").textContent = `í˜„ì¬ ë“±ê¸‰: ${currentGrade}`;

    const isAdmin = (currentGrade === "ì˜");
    $("manageTab").classList.toggle("hidden", !isAdmin);
    $("scoreEditorSection").classList.toggle("hidden", !isAdmin);
  }

  // ===== ê¸°ë³¸ ê´€ë¦¬ì/ê¸°ë³¸ ì¢…ë¥˜ ìƒì„± =====
  

  async function logLogin(grade) {
    await addDoc(colLogs, { grade, time: new Date().toLocaleString(), createdAt: serverTimestamp() });
  }

  // ===== íƒ€ì… ì…€ë ‰íŠ¸ =====
  function renderTypeSelect() {
    const sel = $("typeSelect");
    sel.innerHTML = "";
    if (types.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "ì¢…ë¥˜ ì—†ìŒ(ì˜ê°€ ê´€ë¦¬ì—ì„œ ì¶”ê°€)";
      sel.appendChild(opt);
      sel.disabled = true;
      return;
    }
    sel.disabled = false;
    for (const t of types) {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.name;
      sel.appendChild(opt);
    }

    // ì²« íƒ€ì… ìë™ ì„ íƒ
    if (!selectedTypeId) selectedTypeId = sel.value;
  }

  // ===== ê³¼ëª© ë²„íŠ¼ =====
  function renderSubjectButtons() {
    const wrap = $("subjectButtons");
    wrap.innerHTML = "";
    SUBJECTS.forEach(subj => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "ghost";
      btn.textContent = subj;
      btn.onclick = () => {
        selectedSubject = subj;
        selectedRound = null;
        markActiveButtons();
        renderRoundButtonsAuto();
        updatePickLabel();
        updateDetail();
        renderAllCharts();
      };
      wrap.appendChild(btn);
    });

    if (!selectedSubject) {
      selectedSubject = SUBJECTS[0];
    }
    markActiveButtons();
  }

  function markActiveButtons() {
    [...$("subjectButtons").querySelectorAll("button")].forEach(b=>{
      b.classList.toggle("active", b.textContent === selectedSubject);
    });
    [...$("roundButtons").querySelectorAll("button")].forEach(b=>{
      const r = Number(b.dataset.round);
      b.classList.toggle("active", Number.isFinite(r) && r === selectedRound);
    });
  }

  // ===== ìë™ íšŒì°¨ ë²„íŠ¼ =====
  function renderRoundButtonsAuto() {
    const wrap = $("roundButtons");
    wrap.innerHTML = "";

    if (!selectedTypeId || !selectedSubject) {
      wrap.innerHTML = `<span class="muted">ì¢…ë¥˜/ê³¼ëª©ì„ ë¨¼ì € ì„ íƒí•´ì¤˜</span>`;
      return;
    }

    const rounds = [...new Set(
      scores
        .filter(s => s.typeId === selectedTypeId && s.subject === selectedSubject)
        .map(s => Number(s.round))
        .filter(r => Number.isFinite(r))
    )].sort((a,b)=>a-b);

    if (rounds.length === 0) {
      wrap.innerHTML = `<span class="muted">ì•„ì§ ì €ì¥ëœ íšŒì°¨ê°€ ì—†ì–´ (ì˜ê°€ ì ìˆ˜ ì €ì¥í•˜ë©´ ìë™ ìƒì„±)</span>`;
      return;
    }

    rounds.forEach(r=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "ghost";
      btn.textContent = `${r}íšŒ`;
      btn.dataset.round = String(r);
      btn.onclick = () => {
        selectedRound = r;
        markActiveButtons();
        updatePickLabel();
        updateDetail();
        renderAllCharts();
      };
      wrap.appendChild(btn);
    });

    // ê¸°ë³¸ìœ¼ë¡œ ì²« íšŒì°¨ ìë™ ì„ íƒ(ì—†ìœ¼ë©´ null)
    if (selectedRound == null && rounds.length) selectedRound = rounds[0];
    markActiveButtons();
  }

  function updatePickLabel() {
    const typeName = types.find(t=>t.id===selectedTypeId)?.name ?? "-";
    const subj = selectedSubject ?? "-";
    const rnd = (selectedRound==null) ? "-" : `${selectedRound}íšŒ`;
    $("currentPick").textContent = `${typeName} / ${subj} / ${rnd}`;
  }

  // ===== ë‚´ ì ìˆ˜/í†µê³„/ë‹¨ì› ìƒì„¸ =====
  function getMyScoreDoc() {
    if (!selectedTypeId || !selectedSubject || selectedRound==null) return null;
    return scores.find(s => s.typeId===selectedTypeId && s.subject===selectedSubject && Number(s.round)===Number(selectedRound)) ?? null;
  }

  function getStatDoc() {
    if (!selectedTypeId || !selectedSubject || selectedRound==null) return null;
    return stats.find(s => s.typeId===selectedTypeId && s.subject===selectedSubject && Number(s.round)===Number(selectedRound)) ?? null;
  }

  function getUnitDocs() {
    if (!selectedTypeId || !selectedSubject || selectedRound==null) return [];
    return units
      .filter(u => u.typeId===selectedTypeId && u.subject===selectedSubject && Number(u.round)===Number(selectedRound))
      .slice()
      .sort((a,b)=> (a.unit||"").localeCompare(b.unit||"", "ko"));
  }

  function updateDetail() {
    const my = getMyScoreDoc();
    $("myScoreLabel").textContent = my ? String(my.score) : "-";
    $("myPctLabel").textContent = (my && my.percentile!=null) ? String(my.percentile) : "-";

    const st = getStatDoc();
    $("avgLabel").textContent = st && st.avg!=null ? String(st.avg) : "-";

    const ud = getUnitDocs();
    const tb = $("unitTable");
    tb.innerHTML = "";
    if (ud.length === 0) {
      tb.innerHTML = `<tr><td colspan="3" class="muted">ë‹¨ì› ë°ì´í„° ì—†ìŒ(ì˜ê°€ ê´€ë¦¬ì—ì„œ ì¶”ê°€)</td></tr>`;
    } else {
      ud.forEach(x=>{
        tb.innerHTML += `<tr><td>${escapeHtml(x.unit)}</td><td>${x.score ?? "-"}</td><td>${x.maxScore ?? "-"}</td></tr>`;
      });
    }
  }

  // ===== ì°¨íŠ¸ ë Œë” =====
  function destroyCharts() {
    if (c1) c1.destroy(); if (c2) c2.destroy(); if (c3) c3.destroy(); if (c4) c4.destroy();
    c1=c2=c3=c4=null;
  }

  function renderChart1() {
    // ì„ íƒí•œ ì¢…ë¥˜+ê³¼ëª©ì˜ íšŒì°¨ë³„ ì¶”ì´
    const rows = scores
      .filter(s => s.typeId===selectedTypeId && s.subject===selectedSubject)
      .map(s => ({ r:Number(s.round), v:Number(s.score) }))
      .filter(x => Number.isFinite(x.r) && Number.isFinite(x.v))
      .sort((a,b)=>a.r-b.r);

    const labels = rows.map(x=>`${x.r}íšŒ`);
    const values = rows.map(x=>x.v);

    const ctx = $("chart1").getContext("2d");
    c1 = new Chart(ctx, {
      type:"line",
      data:{ labels, datasets:[{ label:`${selectedSubject} ì ìˆ˜`, data:values, fill:false }] },
      options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function renderChart2() {
    // ë‚´ ëª¨ë“  ì‹œí—˜ì—ì„œ ì„ íƒ ê³¼ëª©ë§Œ ëª¨ì•„ì„œ ì¶”ì´(ì¢…ë¥˜ ìƒê´€ì—†ìŒ)
    const rows = scores
      .filter(s => s.subject===selectedSubject)
      .slice()
      .sort((a,b)=>{
        const ta = a.createdAt?.seconds ?? 0;
        const tb = b.createdAt?.seconds ?? 0;
        return ta - tb;
      });

    const labels = rows.map(s=>{
      const tn = types.find(t=>t.id===s.typeId)?.name ?? "?";
      return `${tn} ${s.round}íšŒ`;
    });
    const values = rows.map(s=>Number(s.score));

    const ctx = $("chart2").getContext("2d");
    c2 = new Chart(ctx, {
      type:"line",
      data:{ labels, datasets:[{ label:`ì „ì²´ ${selectedSubject} ì¶”ì´`, data:values, fill:false }] },
      options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function renderChart3() {
    // í•´ë‹¹ ì‹œí—˜(ì¢…ë¥˜+ê³¼ëª©+íšŒì°¨)ì—ì„œ í‰ê· /ë“±ê¸‰ì»·ê³¼ ë¹„êµ
    const my = getMyScoreDoc();
    const st = getStatDoc();

    const myScore = my ? Number(my.score) : null;
    const avg = st && st.avg!=null ? Number(st.avg) : null;

    // í‘œì‹œí•  ë§‰ëŒ€: ë‚´ ì ìˆ˜, í‰ê· (ìˆìœ¼ë©´)
    const labels = [];
    const values = [];
    if (myScore!=null && Number.isFinite(myScore)) { labels.push("ë‚´ ì ìˆ˜"); values.push(myScore); }
    if (avg!=null && Number.isFinite(avg)) { labels.push("í‰ê· "); values.push(avg); }

    const ctx = $("chart3").getContext("2d");

    // ë“±ê¸‰ì»·(ìˆìœ¼ë©´ ì„ ìœ¼ë¡œ í‘œì‹œ)
    const cuts = [];
    if (st) {
      for (let i=1;i<=9;i++){
        const v = st[`cut${i}`];
        if (v!=null && v!=="" && Number.isFinite(Number(v))) cuts.push({ grade:i, value:Number(v) });
      }
    }

    c3 = new Chart(ctx, {
      type:"bar",
      data:{ labels, datasets:[{ label:`${selectedSubject} ë¹„êµ`, data:values }] },
      options:{
        responsive:true,
        scales:{ y:{ beginAtZero:true } },
        plugins:{
          legend:{ display:true }
        }
      },
      plugins: [{
        id:"cutLines",
        afterDatasetsDraw(chart){
          const {ctx, chartArea:{left,right,top,bottom}, scales:{y}} = chart;
          ctx.save();
          ctx.setLineDash([6,6]);
          ctx.lineWidth = 1;
          cuts.forEach(c=>{
            const yPos = y.getPixelForValue(c.value);
            ctx.beginPath();
            ctx.moveTo(left, yPos);
            ctx.lineTo(right, yPos);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = "#374151";
            ctx.font = "12px system-ui";
            ctx.fillText(`${c.grade}ì»· ${c.value}`, left+6, yPos-4);
            ctx.setLineDash([6,6]);
          });
          ctx.restore();
        }
      }]
    });
  }

  function renderChart4() {
    // ë‹¨ì›ë³„ ì ìˆ˜ ë¹„êµ(í•´ë‹¹ ì‹œí—˜)
    const ud = getUnitDocs();
    const labels = ud.map(x=>x.unit);
    const values = ud.map(x=>Number(x.score));

    const ctx = $("chart4").getContext("2d");
    c4 = new Chart(ctx, {
      type:"bar",
      data:{ labels, datasets:[{ label:`ë‹¨ì›ë³„ ${selectedSubject}`, data:values }] },
      options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function renderAllCharts() {
    if (!selectedTypeId || !selectedSubject) return;
    destroyCharts();
    // íšŒì°¨ ì„ íƒ ì—†ì–´ë„ 1/2ëŠ” ê·¸ë¦´ ìˆ˜ ìˆì§€ë§Œ, 3/4ëŠ” íšŒì°¨ í•„ìš”
    renderChart1();
    renderChart2();
    renderChart3();
    renderChart4();
  }

  // ===== ì ìˆ˜ ì €ì¥/ì—…ë°ì´íŠ¸ (ì˜ ì „ìš©) =====
  async function upsertMyScore() {
    if (currentGrade !== "ì˜") return;
    if (!selectedTypeId || !selectedSubject || selectedRound==null) {
      alert("ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");
      return;
    }

    const score = parseInt($("scoreInput").value, 10);
    if (Number.isNaN(score)) return alert("ì ìˆ˜ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜.");

    const pctRaw = $("percentileInput").value.trim();
    const percentile = pctRaw === "" ? null : parseInt(pctRaw, 10);

    // ë™ì¼ ì¡°í•©(ì¢…ë¥˜+ê³¼ëª©+íšŒì°¨) ë¬¸ì„œ ìˆìœ¼ë©´ update, ì—†ìœ¼ë©´ add
    const existing = getMyScoreDoc();
    if (existing) {
      await updateDoc(doc(db, "sb_scores", existing.id), { score, percentile });
    } else {
      await addDoc(colScores, {
        typeId: selectedTypeId,
        subject: selectedSubject,
        round: Number(selectedRound),
        score,
        percentile,
        createdAt: serverTimestamp()
      });
    }

    $("scoreInput").value = "";
    $("percentileInput").value = "";
  }

  // ===== ê´€ë¦¬: ì¢…ë¥˜/ìœ ì €/ë¡œê·¸ =====
  function renderTypeList() {
    if (currentGrade !== "ì˜") return;
    const wrap = $("typeList");
    if (types.length === 0) {
      wrap.textContent = "ë“±ë¡ëœ ì¢…ë¥˜ ì—†ìŒ";
      return;
    }
    wrap.innerHTML = types.map(t => `
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin:6px 0;">
        <div>â€¢ <b>${escapeHtml(t.name)}</b></div>
        <button class="danger" type="button" onclick="deleteType('${t.id}')">ì‚­ì œ</button>
      </div>
    `).join("");
  }

  window.deleteType = async (typeId) => {
    if (currentGrade !== "ì˜") return;
    const hasScore = scores.some(s => s.typeId === typeId);
    if (hasScore) return alert("ì´ ì¢…ë¥˜ ì ìˆ˜ê°€ ìˆì–´ì„œ ì‚­ì œ ë¶ˆê°€(ì ìˆ˜ ë¨¼ì € ì‚­ì œí•´ì•¼ í•¨)");
    await deleteDoc(doc(db, "sb_types", typeId));
  };

  function renderUsers() {
    if (currentGrade !== "ì˜") return;
    const wrap = $("userList");
    wrap.innerHTML = "";
    users.forEach(u=>{
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div class="t">ë¹„ë°€ë²ˆí˜¸: <b>${escapeHtml(u.password)}</b></div>
        <div class="d">ë“±ê¸‰: <b>${escapeHtml(u.grade)}</b></div>
        <button class="danger" type="button" style="margin-top:8px" onclick="removeUser('${u.id}')">ì‚­ì œ</button>
      `;
      wrap.appendChild(div);
    });
  }

  window.removeUser = async (id) => {
    if (currentGrade !== "ì˜") return;
    const u = users.find(x=>x.id===id);
    if (!u) return;
    if (u.password === "0704160931") return alert("ê¸°ë³¸ ì˜ ë¹„ë²ˆì€ ì‚­ì œí•˜ì§€ ì•ŠëŠ” ê±¸ ì¶”ì²œí•´.");
    await deleteDoc(doc(db, "sb_users", id));
  };

  function renderLogs() {
    if (currentGrade !== "ì˜") return;
    const box = $("loginRecords");
    if (logs.length === 0) return box.textContent = "ê¸°ë¡ ì—†ìŒ";
    box.innerHTML = logs.slice().reverse().map(l=>`â€¢ [${escapeHtml(l.time)}] ë“±ê¸‰: ${escapeHtml(l.grade)}`).join("<br/>");
  }

  // ===== ê´€ë¦¬: í†µê³„ ì €ì¥/ì—…ë°ì´íŠ¸ (ê·¸ë˜í”„3 ë°ì´í„°) =====
  async function upsertStats() {
    if (currentGrade !== "ì˜") return;
    if (!selectedTypeId || !selectedSubject || selectedRound==null) {
      alert("ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");
      return;
    }

    const avg = $("statAvg").value.trim()==="" ? null : Number($("statAvg").value);
    const data = {
      typeId: selectedTypeId,
      subject: selectedSubject,
      round: Number(selectedRound),
      avg: (avg==null || Number.isNaN(avg)) ? null : avg,
      createdAt: serverTimestamp()
    };

    for (let i=1;i<=9;i++){
      const v = $(`cut${i}`).value.trim();
      data[`cut${i}`] = v==="" ? null : Number(v);
      if (Number.isNaN(data[`cut${i}`])) data[`cut${i}`] = null;
    }

    const existing = getStatDoc();
    if (existing) {
      await updateDoc(doc(db, "sb_exam_stats", existing.id), data);
    } else {
      await addDoc(colStats, data);
    }
  }

  // ===== ê´€ë¦¬: ë‹¨ì› ì¶”ê°€ (ê·¸ë˜í”„4 ë°ì´í„°) =====
  async function addUnit() {
    if (currentGrade !== "ì˜") return;
    if (!selectedTypeId || !selectedSubject || selectedRound==null) {
      alert("ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");
      return;
    }

    const unit = $("unitName").value.trim();
    const score = $("unitScore").value.trim()==="" ? null : Number($("unitScore").value);
    const maxScore = $("unitMax").value.trim()==="" ? null : Number($("unitMax").value);

    if (!unit) return alert("ë‹¨ì›ëª…ì„ ì…ë ¥í•´ì¤˜.");
    if (score==null || Number.isNaN(score)) return alert("ë‹¨ì› ì ìˆ˜ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜.");

    await addDoc(colUnits, {
      typeId: selectedTypeId,
      subject: selectedSubject,
      round: Number(selectedRound),
      unit,
      score,
      maxScore: (maxScore==null || Number.isNaN(maxScore)) ? null : maxScore,
      createdAt: serverTimestamp()
    });

    $("unitName").value = "";
    $("unitScore").value = "";
    $("unitMax").value = "";
  }

  // ===== ì‹¤ì‹œê°„ êµ¬ë… =====
  function startRealtime() {
    onSnapshot(query(colTypes, orderBy("createdAt","asc")), (snap)=>{
      types = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderTypeSelect();

      // selectedTypeId ìœ ì§€/ê°±ì‹ 
      const sel = $("typeSelect");
      if (!selectedTypeId && sel.value) selectedTypeId = sel.value;
      if (selectedTypeId && !types.some(t=>t.id===selectedTypeId)) selectedTypeId = sel.value;

      updatePickLabel();
      renderRoundButtonsAuto();
      updateDetail();
      renderAllCharts();

      if (currentGrade==="ì˜") renderTypeList();
    });

    onSnapshot(query(colScores, orderBy("createdAt","asc")), (snap)=>{
      scores = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderRoundButtonsAuto();
      updateDetail();
      renderAllCharts();
    });

    onSnapshot(query(colUsers, orderBy("createdAt","asc")), (snap)=>{
      users = snap.docs.map(d=>({id:d.id, ...d.data()}));
      if (currentGrade==="ì˜") renderUsers();
    });

    onSnapshot(query(colLogs, orderBy("createdAt","asc")), (snap)=>{
      logs = snap.docs.map(d=>({id:d.id, ...d.data()}));
      if (currentGrade==="ì˜") renderLogs();
    });

    onSnapshot(query(colStats, orderBy("createdAt","asc")), (snap)=>{
      stats = snap.docs.map(d=>({id:d.id, ...d.data()}));
      updateDetail();
      renderAllCharts();
    });

    onSnapshot(query(colUnits, orderBy("createdAt","asc")), (snap)=>{
      units = snap.docs.map(d=>({id:d.id, ...d.data()}));
      updateDetail();
      renderAllCharts();
    });
  }

  // ===== ì´ë²¤íŠ¸ =====
  $("typeSelect").addEventListener("change", ()=>{
    selectedTypeId = $("typeSelect").value;
    selectedRound = null;
    updatePickLabel();
    renderRoundButtonsAuto();
    updateDetail();
    renderAllCharts();
  });

  $("loginBtn").addEventListener("click", async ()=>{
    const entered = $("pwInput").value.trim();
    if (!entered) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.");

    await ensureDefaultAdminIfNeeded(entered);

    const snap = await getDocs(colUsers);
    const list = snap.docs.map(d=>({id:d.id, ...d.data()}));
    const found = list.find(u=>u.password===entered);
    if (!found) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");

    currentGrade = found.grade;
    await logLogin(currentGrade);

    applyPermissions();
    renderSubjectButtons();
    updatePickLabel();
    startRealtime();
  });

  $("logoutBtn").addEventListener("click", ()=>{
    // ê°„ë‹¨ ë¡œê·¸ì•„ì›ƒ(ìƒˆë¡œê³ ì¹¨)
    location.reload();
  });

  $("manageTab").addEventListener("click", ()=>{
    if (currentGrade!=="ì˜") return;
    $("manageSection").classList.toggle("hidden");
    renderTypeList();
    renderUsers();
    renderLogs();
    $("manageSection").scrollIntoView({behavior:"smooth", block:"start"});
  });

  $("addTypeBtn").addEventListener("click", async ()=>{
    if (currentGrade!=="ì˜") return;
    const name = $("newTypeInput").value.trim();
    if (!name) return alert("ì¢…ë¥˜ ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
    if (types.some(t=>t.name===name)) return alert("ì´ë¯¸ ìˆëŠ” ì¢…ë¥˜ì•¼.");
    await addDoc(colTypes, { name, createdAt: serverTimestamp() });
    $("newTypeInput").value = "";
  });

  $("addUserBtn").addEventListener("click", async ()=>{
    if (currentGrade!=="ì˜") return;
    const pw = $("newPw").value.trim();
    const grade = $("newGrade").value;
    if (!pw) return alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.");
    if (users.some(u=>u.password===pw)) return alert("ì´ë¯¸ ìˆëŠ” ë¹„ë°€ë²ˆí˜¸ì•¼.");
    await addDoc(colUsers, { password: pw, grade, createdAt: serverTimestamp() });
    $("newPw").value = "";
  });

  $("clearLogsBtn").addEventListener("click", async ()=>{
    if (currentGrade!=="ì˜") return;
    const snap = await getDocs(colLogs);
    await Promise.all(snap.docs.map(d=>deleteDoc(doc(db,"sb_logs", d.id))));
  });

  $("saveScoreBtn").addEventListener("click", upsertMyScore);
  $("saveStatsBtn").addEventListener("click", upsertStats);
  $("addUnitBtn").addEventListener("click", addUnit);
</script>
</body>
</html>


