<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ScoreBoard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; background:linear-gradient(135deg,#111827,#4f46e5); margin:0; padding:20px}
    .container{max-width:1050px;margin:auto;background:#fff;padding:22px 22px 28px;border-radius:18px;box-shadow:0 15px 40px rgba(0,0,0,.25);position:relative}
    h1{margin:6px 0 12px;text-align:center}
    .top-right{position:absolute;top:14px;right:16px;display:flex;gap:10px;align-items:center}
    .link-btn{font-size:12px;color:#4f46e5;cursor:pointer;user-select:none;background:none;border:none}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;margin:6px 0}
    .section{margin-top:16px;padding:14px;border:1px solid #eef2ff;border-radius:14px;background:#fafbff}
    .section h3{margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 180px}
    input,select,button{padding:10px;margin:6px 0;width:100%;box-sizing:border-box;border-radius:10px;border:1px solid #d1d5db}
    button{background:#4f46e5;color:#fff;border:none;cursor:pointer;font-weight:700}
    button:hover{background:#4338ca}
    .ghost{background:#111827}
    .ghost:hover{background:#0b1220}
    .danger{background:#dc2626}
    .danger:hover{background:#b91c1c}
    .muted{color:#6b7280;font-size:12px}
    .hidden{display:none !important}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:12px;overflow:hidden}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:center}
    th{background:#f3f4f6}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    @media (max-width: 860px){.cards{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:12px}
    .card .t{font-weight:800;margin-bottom:4px}
    .card .d{font-size:13px;color:#374151}
    canvas{margin-top:14px}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px}
  </style>
</head>

<body>
  <div class="container">
    <div class="top-right">
      <button id="manageTab" class="link-btn hidden" type="button">ê´€ë¦¬</button>
      <button id="logoutBtn" class="link-btn hidden" type="button">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <h1>ğŸ“Š ScoreBoard</h1>
    <div id="roleBadge" class="badge hidden"></div>

    <!-- ë¡œê·¸ì¸ -->
    <div id="loginSection" class="section">
      <h3>ğŸ” ë¡œê·¸ì¸</h3>
      <input id="pwInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
      <button id="loginBtn">ë¡œê·¸ì¸</button>
      <div class="muted">* ì²˜ìŒì—” ì˜ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•˜ë©´, Firestoreì— ì˜ ê³„ì •ì´ ìë™ìœ¼ë¡œ ìƒì„±ë¼ìš”.</div>
    </div>

    <!-- í†µê³„ -->
    <div id="statsSection" class="section hidden">
      <h3>ğŸ“Œ í†µê³„</h3>
      <div class="cards">
        <div class="card">
          <div class="t">ì „ì²´ í‰ê· (ì´ì )</div>
          <div class="d"><span id="overallAvg" class="pill">-</span></div>
        </div>
        <div class="card">
          <div class="t">ì„ íƒí•œ ì¢…ë¥˜ í‰ê· (ì´ì )</div>
          <div class="d"><span id="typeAvg" class="pill">-</span></div>
        </div>
        <div class="card">
          <div class="t">ì„ íƒí•œ ì¢…ë¥˜+íšŒì°¨ í‰ê· (ì´ì )</div>
          <div class="d"><span id="typeRoundAvg" class="pill">-</span></div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">* í‰ê· ì€ í˜„ì¬ ì €ì¥ëœ ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ìë™ ê³„ì‚°</div>
    </div>

    <!-- ì ìˆ˜ -->
    <div id="scoresSection" class="section hidden">
      <h3>ğŸ“ˆ ì ìˆ˜</h3>

      <!-- ì¢…ë¥˜/íšŒì°¨ ì„ íƒ -->
      <div class="row">
        <select id="typeSelect"></select>
        <input id="roundInput" type="number" placeholder="íšŒì°¨ (ì˜ˆ: 1)" min="1" />
        <input id="examName" placeholder="ì‹œí—˜ ì´ë¦„(ì˜ˆ: 3ì›” í•™í‰)" />
      </div>

      <div id="scoreEditor" class="hidden">
        <div class="row">
          <input id="korean" type="number" placeholder="êµ­ì–´" />
          <input id="math" type="number" placeholder="ìˆ˜í•™" />
          <input id="english" type="number" placeholder="ì˜ì–´" />
          <input id="percentile" type="number" placeholder="ë°±ë¶„ìœ„(ì„ íƒ)" min="0" max="100"/>
        </div>
        <button id="addScoreBtn">ì ìˆ˜ ì¶”ê°€</button>
        <div class="muted">* ì ìˆ˜ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œëŠ” <b>ì˜</b> ë“±ê¸‰ë§Œ ê°€ëŠ¥</div>
      </div>

      <table>
        <thead>
          <tr>
            <th>ì¢…ë¥˜</th><th>íšŒì°¨</th><th>ì‹œí—˜</th><th>êµ­ì–´</th><th>ìˆ˜í•™</th><th>ì˜ì–´</th><th>ì´ì </th><th>ë°±ë¶„ìœ„</th>
            <th id="editColHead" class="hidden">ìˆ˜ì •</th>
            <th id="delColHead" class="hidden">ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody id="scoreTable"></tbody>
      </table>

      <canvas id="scoreChart"></canvas>
    </div>

    <!-- ìë£Œì‹¤ (ë“±ê¸‰ ë†’ì„ìˆ˜ë¡ ë” ë§ì´ ë´„) -->
    <div id="materialsSection" class="section hidden">
      <h3>ğŸ“š ì£¼ìš”ìë£Œ</h3>
      <div class="muted">ë“±ê¸‰ì´ ë†’ì„ìˆ˜ë¡ ë” ë§ì´ ë´„ (ì˜&gt;ì¹˜&gt;í•œ&gt;ì•½&gt;ìˆ˜)</div>
      <div class="cards" style="margin-top:10px">
        <div class="card" data-grade="ì¹˜">
          <div class="t">ì¹˜ ë“±ê¸‰ ìë£Œ</div><div class="d">ì¹˜ ì´ìƒë§Œ ì—´ëŒ</div>
        </div>
        <div class="card" data-grade="í•œ">
          <div class="t">í•œ ë“±ê¸‰ ìë£Œ</div><div class="d">í•œ ì´ìƒë§Œ ì—´ëŒ</div>
        </div>
        <div class="card" data-grade="ì•½">
          <div class="t">ì•½ ë“±ê¸‰ ìë£Œ</div><div class="d">ì•½ ì´ìƒë§Œ ì—´ëŒ</div>
        </div>
        <div class="card" data-grade="ìˆ˜">
          <div class="t">ìˆ˜ ë“±ê¸‰ ìë£Œ</div><div class="d">ëª¨ë“  ë“±ê¸‰ ì—´ëŒ</div>
        </div>
      </div>
    </div>

    <!-- ëŒ€í•™ì •ë³´: í•œ ì´ìƒ -->
    <div id="universitySection" class="section hidden">
      <h3>ğŸ“ ëŒ€í•™ì •ë³´ (í•œ ì´ìƒ)</h3>
      <div class="muted">ë‚˜ì¤‘ì— â€œë°±ë¶„ìœ„ë³„ ëŒ€í•™ ë¦¬ìŠ¤íŠ¸â€ë¥¼ ì£¼ë©´ ì—¬ê¸°ì„œ ìë™ìœ¼ë¡œ ì¹´ë“œë¡œ ë³´ì—¬ì£¼ê²Œ ì—°ê²°í•´ì¤„ê²Œ.</div>
      <div class="cards" style="margin-top:10px">
        <div class="card"><div class="t">ì˜ˆì‹œ ì¹´ë“œ</div><div class="d">ë°±ë¶„ìœ„ 96+ â†’ â—‹â—‹ëŒ€â€¦</div></div>
        <div class="card"><div class="t">ì˜ˆì‹œ ì¹´ë“œ</div><div class="d">ë°±ë¶„ìœ„ 90+ â†’ â–¡â–¡ëŒ€â€¦</div></div>
        <div class="card"><div class="t">ì˜ˆì‹œ ì¹´ë“œ</div><div class="d">ë°±ë¶„ìœ„ 85+ â†’ â–³â–³ëŒ€â€¦</div></div>
      </div>
    </div>

    <!-- 2026 ì •ë³´: ì¹˜ ì´ìƒ -->
    <div id="info2026Section" class="section hidden">
      <h3>ğŸ—“ 2026í•™ë…„ë„ ì‹¤ëª¨/ì‹œí—˜ ì •ë³´ (ì¹˜ ì´ìƒ)</h3>
      <div class="cards" style="margin-top:10px">
        <div class="card"><div class="t">ì˜ˆì‹œ) ì¼ì •</div><div class="d">2026 í•™í‰/ì‹¤ëª¨ ì¼ì • ì •ë¦¬</div></div>
        <div class="card"><div class="t">ì˜ˆì‹œ) ì²´í¬ë¦¬ìŠ¤íŠ¸</div><div class="d">ì˜¤ë‹µ/ì‹œê°„/ì „ëµ ë©”ëª¨</div></div>
        <div class="card"><div class="t">ì˜ˆì‹œ) ìë£Œ</div><div class="d">í•„ìš”í•œ ê²ƒë“¤ ëª¨ìŒ</div></div>
      </div>
    </div>

    <!-- ê´€ë¦¬(ì˜ ì „ìš©): ì¢…ë¥˜/ê³„ì •/ë¡œê·¸ -->
    <div id="manageSection" class="section hidden">
      <h3>ğŸ›  ê´€ë¦¬ (ì˜ ì „ìš©)</h3>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§© ëª¨ì˜ê³ ì‚¬ ì¢…ë¥˜ ê´€ë¦¬</h3>
        <div class="row">
          <input id="newTypeInput" placeholder="ìƒˆ ì¢…ë¥˜ ì´ë¦„ (ì˜ˆ: í•™ë ¥í‰ê°€, ì„œë°”ì´ë²Œ)" />
          <button id="addTypeBtn" class="ghost" type="button">ì¢…ë¥˜ ì¶”ê°€</button>
        </div>
        <div id="typeList" class="muted"></div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ‘¤ ë¹„ë°€ë²ˆí˜¸/ë“±ê¸‰ ë§Œë“¤ê¸°</h3>
        <div class="row">
          <input id="newPw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸(ì‚¬ëŒë³„ë¡œ)" />
          <select id="newGrade">
            <option value="ì¹˜">ì¹˜</option>
            <option value="í•œ">í•œ</option>
            <option value="ì•½">ì•½</option>
            <option value="ìˆ˜">ìˆ˜</option>
            <option value="ì˜">ì˜</option>
          </select>
          <button id="addUserBtn" class="ghost" type="button">ì¶”ê°€</button>
        </div>
        <div class="muted">* ì˜ ë“±ê¸‰ì€ ê´€ë¦¬ì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì›ë¬¸ìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥</div>
        <div id="userList" style="margin-top:10px"></div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§¾ ë¡œê·¸ì¸ ê¸°ë¡</h3>
        <div id="loginRecords" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
        <button id="clearLogsBtn" class="danger" type="button">ë¡œê·¸ì¸ ê¸°ë¡ ì „ì²´ ì‚­ì œ</button>
      </div>
    </div>

  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import {
    getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc,
    onSnapshot, query, orderBy, serverTimestamp, getDocs, limit
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  // âœ… ì—¬ê¸° firebaseConfigë¥¼ ë„ˆ í™”ë©´ ê°’ìœ¼ë¡œ ê·¸ëŒ€ë¡œ ë°”ê¿”ë„£ê¸°
  const firebaseConfig = {
  apiKey: "AIzaSyCuMFRksmpH0TuNqv3YoMa76DAAN4r3B84",
  authDomain: "scoreboard-d4bf9.firebaseapp.com",
  projectId: "scoreboard-d4bf9",
  storageBucket: "scoreboard-d4bf9.firebasestorage.app",
  messagingSenderId: "272482248722",
  appId: "1:272482248722:web:81147fe66081feb9da50cb",
  measurementId: "G-VC1922P5SV"
};


  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== ì»¬ë ‰ì…˜ =====
  const colTypes  = collection(db, "sb_types");
  const colScores = collection(db, "sb_scores");
  const colUsers  = collection(db, "sb_users");
  const colLogs   = collection(db, "sb_logs");

  // ===== ë“±ê¸‰ =====
  const gradeHierarchy = { "ì˜": 5, "ì¹˜": 4, "í•œ": 3, "ì•½": 2, "ìˆ˜": 1 };

  // ===== DOM =====
  const $ = (id) => document.getElementById(id);

  // ===== ìƒíƒœ =====
  let currentGrade = null;
  let types = [];   // {id, name}
  let scores = [];  // {id, typeId, typeName, round, examName, korean, math, english, total, percentile, createdAt}
  let users  = [];  // {id, password, grade}
  let logs   = [];  // {id, grade, time, createdAt}

  // ===== ì°¨íŠ¸ =====
  let chart = null;

  // ====== ìœ í‹¸ ======
  const escapeHtml = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const avg = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : null;
  const fmt = (n) => (n==null || Number.isNaN(n)) ? "-" : (Math.round(n*10)/10).toString();

  // ===== ê¶Œí•œ ì ìš© =====
  function applyPermissions() {
    const level = gradeHierarchy[currentGrade];

    $("loginSection").classList.add("hidden");
    $("scoresSection").classList.remove("hidden");
    $("statsSection").classList.remove("hidden");
    $("materialsSection").classList.remove("hidden");
    $("logoutBtn").classList.remove("hidden");

    $("roleBadge").classList.remove("hidden");
    $("roleBadge").textContent = `í˜„ì¬ ë“±ê¸‰: ${currentGrade}`;

    const isUi = (currentGrade === "ì˜");
    $("scoreEditor").classList.toggle("hidden", !isUi);
    $("delColHead").classList.toggle("hidden", !isUi);
    $("editColHead").classList.toggle("hidden", !isUi);
    $("manageTab").classList.toggle("hidden", !isUi);

    // ëŒ€í•™ì •ë³´: í•œ ì´ìƒ
    $("universitySection").classList.toggle("hidden", !(level >= gradeHierarchy["í•œ"]));
    // 2026 ì •ë³´: ì¹˜ ì´ìƒ
    $("info2026Section").classList.toggle("hidden", !(level >= gradeHierarchy["ì¹˜"]));

    // ìë£Œì‹¤ ì¹´ë“œ: ìƒìœ„ê°€ í•˜ìœ„ê¹Œì§€ ë´„
    document.querySelectorAll("[data-grade]").forEach(card => {
      const g = card.getAttribute("data-grade");
      card.style.display = (level >= gradeHierarchy[g]) ? "block" : "none";
    });
  }

  // ===== íƒ€ì… UI =====
  function renderTypeSelect() {
    const sel = $("typeSelect");
    sel.innerHTML = "";
    if (types.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "ì¢…ë¥˜ ì—†ìŒ(ì˜ê°€ ê´€ë¦¬ì—ì„œ ì¶”ê°€)";
      sel.appendChild(opt);
      sel.disabled = true;
      return;
    }
    sel.disabled = false;
    for (const t of types) {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.name;
      sel.appendChild(opt);
    }
  }

  function renderTypeList() {
    if (currentGrade !== "ì˜") return;
    const wrap = $("typeList");
    if (!wrap) return;
    if (types.length === 0) {
      wrap.innerHTML = "ë“±ë¡ëœ ì¢…ë¥˜ ì—†ìŒ";
      return;
    }
    wrap.innerHTML = types.map(t => `
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin:6px 0;">
        <div>â€¢ <b>${escapeHtml(t.name)}</b></div>
        <button class="danger" type="button" onclick="deleteType('${t.id}')">ì‚­ì œ</button>
      </div>
    `).join("");
  }

  window.deleteType = async (typeId) => {
    if (currentGrade !== "ì˜") return;
    // ì´ íƒ€ì… ì ìˆ˜ê°€ ìˆìœ¼ë©´ ì‚­ì œ ë§‰ê¸°(ì‹¤ìˆ˜ ë°©ì§€)
    const hasScore = scores.some(s => s.typeId === typeId);
    if (hasScore) {
      alert("ì´ ì¢…ë¥˜ë¡œ ì €ì¥ëœ ì ìˆ˜ê°€ ìˆì–´ì„œ ì‚­ì œí•  ìˆ˜ ì—†ì–´. (ì ìˆ˜ ë¨¼ì € ì‚­ì œí•´ì•¼ í•¨)");
      return;
    }
    await deleteDoc(doc(db, "sb_types", typeId));
  };

  // ===== ì ìˆ˜ UI =====
  function renderTable() {
    const tbody = $("scoreTable");
    tbody.innerHTML = "";

    for (const s of scores) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(s.typeName)}</td>
        <td>${escapeHtml(s.round)}</td>
        <td>${escapeHtml(s.examName)}</td>
        <td>${s.korean}</td>
        <td>${s.math}</td>
        <td>${s.english}</td>
        <td><b>${s.total}</b></td>
        <td>${s.percentile ?? "-"}</td>
        ${currentGrade === "ì˜" ? `<td><button class="ghost" type="button" onclick="editScore('${s.id}')">ìˆ˜ì •</button></td>` : ""}
        ${currentGrade === "ì˜" ? `<td><button class="danger" type="button" onclick="deleteScore('${s.id}')">ì‚­ì œ</button></td>` : ""}
      `;
      tbody.appendChild(tr);
    }
  }

  function renderChart() {
    const canvas = $("scoreChart");
    const ctx = canvas.getContext("2d");
    const labels = scores.map(s => `${s.typeName} ${s.round}íšŒ`);
    const totals = scores.map(s => s.total);

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "line",
      data: { labels, datasets: [{ label: "ì´ì  ì¶”ì´", data: totals, fill: false }] },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  }

  function renderStats() {
    // ì „ì²´ í‰ê· 
    $("overallAvg").textContent = fmt(avg(scores.map(s => s.total)));

    const selectedTypeId = $("typeSelect").value;
    const selectedRound = parseInt($("roundInput").value, 10);

    const byType = scores.filter(s => s.typeId === selectedTypeId);
    $("typeAvg").textContent = fmt(avg(byType.map(s => s.total)));

    const byTypeRound = byType.filter(s => s.round === selectedRound);
    $("typeRoundAvg").textContent = fmt(avg(byTypeRound.map(s => s.total)));
  }

  $("typeSelect").addEventListener("change", renderStats);
  $("roundInput").addEventListener("input", renderStats);

  window.deleteScore = async (id) => {
    if (currentGrade !== "ì˜") return;
    await deleteDoc(doc(db, "sb_scores", id));
  };

  window.editScore = async (id) => {
    if (currentGrade !== "ì˜") return;
    const s = scores.find(x => x.id === id);
    if (!s) return;

    const nk = prompt("êµ­ì–´ ì ìˆ˜", s.korean);
    if (nk === null) return;
    const nm = prompt("ìˆ˜í•™ ì ìˆ˜", s.math);
    if (nm === null) return;
    const ne = prompt("ì˜ì–´ ì ìˆ˜", s.english);
    if (ne === null) return;
    const np = prompt("ë°±ë¶„ìœ„(ì—†ìœ¼ë©´ ë¹ˆì¹¸)", s.percentile ?? "");
    if (np === null) return;

    const korean = parseInt(nk, 10);
    const math = parseInt(nm, 10);
    const english = parseInt(ne, 10);
    if ([korean, math, english].some(v => Number.isNaN(v))) {
      alert("ì ìˆ˜ëŠ” ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜.");
      return;
    }
    const total = korean + math + english;
    const percentile = (np.trim()==="") ? null : parseInt(np, 10);

    await updateDoc(doc(db, "sb_scores", id), { korean, math, english, total, percentile });
  };

  // ===== ìœ ì €(ë¹„ë°€ë²ˆí˜¸/ë“±ê¸‰) ê´€ë¦¬ =====
  function renderUsers() {
    if (currentGrade !== "ì˜") return;
    const wrap = $("userList");
    wrap.innerHTML = "";

    users.forEach(u => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div class="t">ë¹„ë°€ë²ˆí˜¸: <b>${escapeHtml(u.password)}</b></div>
        <div class="d">ë“±ê¸‰: <b>${u.grade}</b></div>
        <button class="danger" type="button" style="margin-top:8px" onclick="removeUser('${u.id}')">ì‚­ì œ</button>
      `;
      wrap.appendChild(div);
    });
  }

  window.removeUser = async (id) => {
    if (currentGrade !== "ì˜") return;
    const u = users.find(x => x.id === id);
    if (!u) return;
    if (u.password === "0704160931") {
      alert("ê¸°ë³¸ ì˜ ë¹„ë²ˆì€ ì‚­ì œí•˜ì§€ ì•ŠëŠ” ê±¸ ì¶”ì²œí•´.");
      return;
    }
    await deleteDoc(doc(db, "sb_users", id));
  };

  function renderLogs() {
    if (currentGrade !== "ì˜") return;
    const box = $("loginRecords");
    if (!box) return;
    if (logs.length === 0) {
      box.textContent = "ê¸°ë¡ ì—†ìŒ";
      return;
    }
    box.innerHTML = logs.slice().reverse().map(l => `â€¢ [${escapeHtml(l.time)}] ë“±ê¸‰: ${escapeHtml(l.grade)}`).join("<br/>");
  }

  // ===== Firestore ì‹¤ì‹œê°„ êµ¬ë… =====
  function startRealtime() {
    onSnapshot(query(colTypes, orderBy("createdAt", "asc")), (snap) => {
      types = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderTypeSelect();
      if (currentGrade === "ì˜") renderTypeList();
      renderStats();
    });

    onSnapshot(query(colScores, orderBy("createdAt", "asc")), (snap) => {
      const typeMap = new Map(types.map(t => [t.id, t.name]));
      scores = snap.docs.map(d => {
        const data = d.data();
        return {
          id: d.id,
          ...data,
          typeName: typeMap.get(data.typeId) ?? "(ì‚­ì œëœ ì¢…ë¥˜)"
        };
      });
      renderTable();
      renderChart();
      renderStats();
    });

    onSnapshot(query(colUsers, orderBy("createdAt", "asc")), (snap) => {
      users = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      if (currentGrade === "ì˜") renderUsers();
    });

    onSnapshot(query(colLogs, orderBy("createdAt", "asc")), (snap) => {
      logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      if (currentGrade === "ì˜") renderLogs();
    });
  }

  // ===== ë¡œê·¸ì¸ =====
  async function ensureDefaultAdminIfNeeded(enteredPw) {
    // usersê°€ ë¹„ì–´ìˆê³  enteredê°€ ê¸°ë³¸ ì˜ ë¹„ë²ˆì´ë©´ ìë™ ìƒì„±
    const snap = await getDocs(query(colUsers, limit(1)));
    if (snap.empty && enteredPw === "0704160931") {
      await addDoc(colUsers, { password: "0704160931", grade: "ì˜", createdAt: serverTimestamp() });
      // ê¸°ë³¸ íƒ€ì…ë„ í•˜ë‚˜ ë§Œë“¤ì–´ì£¼ê¸°(ì—†ìœ¼ë©´ UIê°€ ë‹µë‹µí•˜ë‹ˆê¹Œ)
      const typeSnap = await getDocs(query(colTypes, limit(1)));
      if (typeSnap.empty) {
        await addDoc(colTypes, { name: "í•™ë ¥í‰ê°€", createdAt: serverTimestamp() });
        await addDoc(colTypes, { name: "ì„œë°”ì´ë²Œ", createdAt: serverTimestamp() });
      }
      return true;
    }
    return false;
  }

  async function logLogin(grade) {
    await addDoc(colLogs, { grade, time: new Date().toLocaleString(), createdAt: serverTimestamp() });
  }

  $("loginBtn").addEventListener("click", async () => {
    const entered = $("pwInput").value.trim();
    if (!entered) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.");

    await ensureDefaultAdminIfNeeded(entered);

    // users ëª©ë¡ì„ í•œë²ˆ ì½ì–´ ë¡œê·¸ì¸ í™•ì¸
    const snap = await getDocs(colUsers);
    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    const found = list.find(u => u.password === entered);
    if (!found) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");

    currentGrade = found.grade;
    await logLogin(currentGrade);

    applyPermissions();
    startRealtime();
  });

  // ===== ì ìˆ˜ ì¶”ê°€ =====
  $("addScoreBtn").addEventListener("click", async () => {
    if (currentGrade !== "ì˜") return;

    const typeId = $("typeSelect").value;
    const round = parseInt($("roundInput").value, 10);
    const examName = $("examName").value.trim();

    const korean = parseInt($("korean").value, 10);
    const math = parseInt($("math").value, 10);
    const english = parseInt($("english").value, 10);
    const percentileRaw = $("percentile").value.trim();

    if (!typeId) return alert("ëª¨ì˜ê³ ì‚¬ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì¤˜.");
    if (Number.isNaN(round) || round < 1) return alert("íšŒì°¨ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜ (ì˜ˆ: 1).");
    if (!examName) return alert("ì‹œí—˜ ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
    if ([korean, math, english].some(v => Number.isNaN(v))) return alert("ì ìˆ˜ë¥¼ ëª¨ë‘ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜.");

    const total = korean + math + english;
    const percentile = percentileRaw === "" ? null : parseInt(percentileRaw, 10);

    await addDoc(colScores, {
      typeId,
      round,
      examName,
      korean, math, english,
      total,
      percentile,
      createdAt: serverTimestamp()
    });

    // ì…ë ¥ì¹¸ ì •ë¦¬
    $("examName").value = "";
    $("korean").value = "";
    $("math").value = "";
    $("english").value = "";
    $("percentile").value = "";
  });

  // ===== ê´€ë¦¬íƒ­ =====
  $("manageTab").addEventListener("click", () => {
    if (currentGrade !== "ì˜") return;
    $("manageSection").classList.toggle("hidden");
    renderUsers();
    renderLogs();
    renderTypeList();
    $("manageSection").scrollIntoView({ behavior: "smooth", block: "start" });
  });

  $("addTypeBtn").addEventListener("click", async () => {
    if (currentGrade !== "ì˜") return;
    const name = $("newTypeInput").value.trim();
    if (!name) return alert("ì¢…ë¥˜ ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
    // ì¤‘ë³µ ë°©ì§€
    if (types.some(t => t.name === name)) return alert("ì´ë¯¸ ìˆëŠ” ì¢…ë¥˜ì•¼.");
    await addDoc(colTypes, { name, createdAt: serverTimestamp() });
    $("newTypeInput").value = "";
  });

  $("addUserBtn").addEventListener("click", async () => {
    if (currentGrade !== "ì˜") return;
    const pw = $("newPw").value.trim();
    const grade = $("newGrade").value;
    if (!pw) return alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.");
    // ì¤‘ë³µ ë°©ì§€
    if (users.some(u => u.password === pw)) return alert("ì´ë¯¸ ìˆëŠ” ë¹„ë°€ë²ˆí˜¸ì•¼.");
    await addDoc(colUsers, { password: pw, grade, createdAt: serverTimestamp() });
    $("newPw").value = "";
  });

  $("clearLogsBtn").addEventListener("click", async () => {
    if (currentGrade !== "ì˜") return;
    // ë¡œê·¸ ì „ë¶€ ì‚­ì œ(ê°„ë‹¨ êµ¬í˜„)
    const snap = await getDocs(colLogs);
    const promises = snap.docs.map(d => deleteDoc(doc(db, "sb_logs", d.id)));
    await Promise.all(promises);
  });

  // ===== ë¡œê·¸ì•„ì›ƒ =====
  $("logoutBtn").addEventListener("click", () => {
    currentGrade = null;
    $("loginSection").classList.remove("hidden");
    $("scoresSection").classList.add("hidden");
    $("statsSection").classList.add("hidden");
    $("materialsSection").classList.add("hidden");
    $("universitySection").classList.add("hidden");
    $("info2026Section").classList.add("hidden");
    $("manageSection").classList.add("hidden");
    $("roleBadge").classList.add("hidden");
    $("manageTab").classList.add("hidden");
    $("logoutBtn").classList.add("hidden");
    $("pwInput").value = "";
  });

</script>
</body>
</html>

